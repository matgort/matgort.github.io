
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#F7C6D0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Object Poems</title>

  <style>
    :root{
      --fg: rgba(0,0,0,0.92);
      --ui: rgba(0,0,0,0.72);
      --ui3: rgba(0,0,0,0.20);
      --vh: 1vh;

      /* UI sizing (gold-standard) */
      --barH: clamp(175px, 21vh, 240px); /* slightly squished vertically */
      --barOffset: 40px; /* LOWER all UI by ~10px vs 50 (since barOffset raises UI up) */

      /* slight scale that doesn't break layout */
      --uiScale: 1.02;

      /* Phrase layout */
      --textScale: 1;
      --fitScale: 1;
      --yPct: 50%;
      --phraseW: 75vw;
      --edgePad: 50px;

      /* Sentence-structure pill sizing */
      --pillH: 16px;
      --pillPadX: 10px;
      --pillFont: 7.1px;

      /* Swatches */
      --swOuter: 1px;
      --swRing: 4px;
      --swW: calc(var(--pillH) * 2);

      /* Global UI padding request */
      --uiPadX: 20px;

      /* Narrow UI lane (your mockup’s big move) */
      --uiMaxW: 1120px;
      --uiW: min(
        var(--uiMaxW),
        calc(
          100vw
          - (var(--uiPadX) * 2)
          - env(safe-area-inset-left, 0px)
          - env(safe-area-inset-right, 0px)
        )
      );

      /* Title placement (now part of UI + fades) */
      --titlePadTop: 18px; /* moved DOWN slightly */
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0; padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      background:#F7C6D0;
      font-family: "Times New Roman", Times, Georgia, serif;
      -webkit-text-size-adjust: 100%;
    }

    body{ min-height: calc(var(--vh, 1vh) * 100); }

    /* Stage above border, below UI */
    #stage{
      position: fixed;
      top:0; left:0;
      width:100vw;
      height: calc(var(--vh, 1vh) * 100);
      pointer-events:none;
      z-index: 20;
    }

    #phrase{
      position:absolute;
      left:50%;
      top: var(--yPct);
      transform: translate(-50%, -50%);
      font-weight: 650;
      font-size: calc(clamp(32px, 5vw, 92px) * var(--textScale) * var(--fitScale));
      line-height:1.12;
      letter-spacing:.2px;
      user-select:none;

      width: var(--phraseW);
      max-width: calc(100vw - (var(--edgePad) * 2));
      text-align:center;

      white-space: normal;
      overflow-wrap: normal;
      word-break: normal;
      hyphens: none;
    }

    /* Border behind everything */
    #borderFrame{
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: none;
      z-index: 5;
      overflow: visible;
    }
    #borderFrame .b{
      position: fixed;
      background: transparent;
      pointer-events: none;
    }
    #borderFrame .top { left:0; right:0; top:0; height:0; }
    #borderFrame .bottom { left:0; right:0; bottom:0; height:0; }
    #borderFrame .left { top:0; bottom:0; left:0; width:0; }
    #borderFrame .right { top:0; bottom:0; right:0; width:0; }

    /* ===== UI wrapper (title + bar) =====
       Title is now part of this UI and fades with it.
    */
    #uiWrap{
      position: fixed;
      left:0; right:0;
      top:0; bottom:0;
      z-index: 30;
      pointer-events: none; /* bar re-enables */
      transition: opacity .18s ease, transform .18s ease;
    }
    #uiWrap.hidden{
      opacity:0;
      transform: translateY(10px);
    }

    /* ===== Title (inside uiWrap, NOT pointer-interactive) ===== */
    #titleBlock{
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + var(--titlePadTop));
      left: 0;
      right: 0;
      z-index: 40;
      pointer-events: none;

      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;

      width: var(--uiW);
      max-width: var(--uiMaxW);
      margin-left: auto;
      margin-right: auto;

      text-align:center;
      color: var(--ui);
    }
    #titleBlock .title{
      font-size: 15.5px;
      letter-spacing: .22em;
      text-transform: uppercase;
      line-height: 1;
      font-weight: 700;
    }
    #titleBlock .sub{
      font-size: 10.5px;
      letter-spacing: .11em;
      text-transform: uppercase;
      line-height: 1.2;
      font-weight: 560;
      opacity: .88;
    }

    /* ===== UI bar ===== */
    #bar{
      position: fixed;
      left:0; right:0;
      bottom: calc(env(safe-area-inset-bottom, 0px) + var(--barOffset));
      height: var(--barH);

      padding-left: calc(env(safe-area-inset-left, 0px) + var(--uiPadX));
      padding-right: calc(env(safe-area-inset-right, 0px) + var(--uiPadX));
      padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));

      pointer-events:auto; /* clickable */
      background: transparent;

      max-height: calc(var(--vh, 1vh) * 100 - 8px);
      overflow: visible;
    }

    .barInner{
      width: var(--uiW);
      max-width: var(--uiMaxW);
      margin-left: auto;
      margin-right: auto;

      padding-top: 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      height:100%;
      overflow: visible;

      transform: scale(var(--uiScale));
      transform-origin: bottom center;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:nowrap;
      min-width:0;
    }
    .centerRow{
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    /* centered 3 swatch sections */
    .colorsRow{
      justify-content: center;
      align-items:flex-end;
      gap: 28px;
      flex-wrap:nowrap;
    }

    .grp{
      display:flex;
      flex-direction:column;
      gap:5px;
      min-width:0;
      flex: 0 1 360px;
    }
    .grp.words{
      flex: 0 0 auto;
      align-items: center;
    }

    .label{
      font-size: 9px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--ui);
      user-select:none;
      line-height:1;
      opacity:.82;
      display:block;
      white-space:nowrap;
    }
    .labelRow{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }
    .val{
      font-size: 9px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--ui);
      opacity:.9;
      user-select:none;
      white-space:nowrap;
    }

    button{
      font: inherit;
      font-weight: 520;
      font-size: 7.1px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ui);
      background: transparent;
      border: 1px solid var(--ui3);
      border-radius: 999px;
      padding: 3.6px 6px;
      cursor: pointer;
      line-height: 1;
      user-select: none;
      white-space: nowrap;
      transition: transform .05s ease, border-color .15s ease, color .15s ease, background-color .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    button:hover{ color: var(--fg); border-color: var(--ui); }

    .colorBtn{
      background: var(--btnBg, transparent);
      border-color: var(--ui3);
      color: var(--ui);
    }
    .colorBtn:hover{
      filter: brightness(0.5);
      color: var(--ui);
      border-color: var(--ui3);
    }
    .colorBtn:not(.on){
      background: transparent;
    }
    .colorBtn.disabled{
      opacity: 0.55;
      cursor: default;
      filter: none;
    }

    .btnGroup{
      display:flex;
      flex-wrap:wrap;
      gap:4.5px;
      align-items:center;
      min-width:0;
      overflow: visible;
    }
    .btnGroup.centered{ justify-content: center; }

    .actionSlot{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      margin-left:auto;
      flex: 0 0 auto;
    }
    .actionBtn{
      text-align:center;
      min-width: 110px;
    }


    .ssBtn{
      height: var(--pillH);
      padding: 0 var(--pillPadX);
      border-radius: 999px;
      border: 1px solid transparent;
      font-weight: 520;
      font-size: var(--pillFont);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color: var(--fg);
      background: transparent;
    }
    .ssBtn.on{
      background: var(--ssBg);
      color: var(--fg);
      border-color: transparent;
    }
    .ssBtn:not(.on){
      background: transparent !important;
      color: var(--fg) !important;
      border-color: var(--fg) !important;
    }
    .ssBtn:hover{ filter: brightness(0.5); }

    .sliderRow{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:nowrap;
      min-width:0;
    }
    .ctrl{
      flex: 1 1 0;
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    input[type=range]{
      appearance:none;
      width:100%;
      height:16px;
      background:transparent;
      color: var(--thumbCol, var(--fg));
      margin:0;
      padding:0;
      touch-action: none;
    }
    input[type=range]::-webkit-slider-runnable-track{
      height:2px;
      background:var(--ui3);
      border-radius:999px;
    }
    input[type=range]::-moz-range-track{
      height:2px;
      background:var(--ui3);
      border-radius:999px;
    }
    input[type=range]::-webkit-slider-thumb{
      appearance:none;
      width:10px; height:10px;
      border-radius:50%;
      background: currentColor;
      margin-top:-4px;
    }
    input[type=range]::-moz-range-thumb{
      width:10px; height:10px;
      border-radius:50%;
      background: currentColor;
      border:0;
    }

    .swatchWrap{
      display:flex;
      flex-direction:column;
      gap:5px;
      width:100%;
      max-width:100%;
      align-items:center;
    }
    .swatchHeader{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      width: fit-content;
    }
    .hoverVal{ min-width: 7ch; text-align: right; }

    .swatchRow{
      display:flex;
      flex-wrap:nowrap;
      gap: 10px;
      align-items:center;
      justify-content:center;
      min-width:0;
      max-width: 100%;
      width: fit-content;
    }

    .swatch{
      width: var(--swW);
      height: var(--pillH);
      padding: 0;
      border-radius: 999px;
      border: var(--swOuter) solid var(--fg);
      background: color-mix(in srgb, var(--fillCol) 18%, transparent);
      box-shadow: inset 0 0 0 var(--swRing) color-mix(in srgb, var(--ringCol) 30%, transparent);
      cursor: pointer;
      transition: transform .05s ease, filter .12s ease, box-shadow .12s ease, background-color .12s ease;
    }
    .swatch:active{ transform: translateY(1px); }

    .swatch.on{
      background: var(--fillCol);
      box-shadow: inset 0 0 0 var(--swRing) var(--ringCol);
    }
    .swatch:hover{ filter: brightness(0.5); }

    @supports not (color-mix(in srgb, red 30%, transparent)){
      .swatch{
        background: transparent;
        box-shadow: inset 0 0 0 var(--swRing) var(--ringCol);
        opacity: 0.75;
      }
      .swatch.on{
        background: var(--fillCol);
        opacity: 1;
      }
    }

    @media (pointer: coarse){
      :root{
        --pillH: 18px;
        --pillPadX: 12px;
        --pillFont: 7.6px;
      }
      button{ font-size: 7.4px; padding: 5px 8px; }
      input[type=range]{ height: 22px; }
      input[type=range]::-webkit-slider-thumb{
        width:14px; height:14px;
        margin-top:-6px;
      }
      input[type=range]::-moz-range-thumb{
        width:14px; height:14px;
      }
    }

    @media(max-width: 980px){
      :root{
        --barH: clamp(240px, 34vh, 330px);
        --barOffset: 30px;
        --uiMaxW: 980px;
      }
      .row, .sliderRow{ flex-wrap:wrap; }
      .colorsRow{ flex-wrap:wrap; }
      .grp{ flex: 1 1 320px; }
      .swatchRow{ flex-wrap:wrap; }
    }

    @media(max-width: 640px){
      :root{
        --barH: clamp(260px, 40vh, 370px);
        --barOffset: 20px;
        --pillH: 15px;
        --swW: calc(var(--pillH) * 2);
        --uiMaxW: 620px;
        --titlePadTop: 16px;
      }
      #phrase{ font-size: calc(clamp(28px, 7vw, 70px) * var(--textScale) * var(--fitScale)); }
      #titleBlock .title{ font-size: 14px; }
      #titleBlock .sub{ font-size: 10px; }
      button{ font-size: 6.8px; padding: 3.4px 5.3px; }
      .label, .val{ font-size: 8.5px; }
      .btnGroup{ gap:4px; }
      .swatchRow{ gap: 9px; flex-wrap:wrap; }
    }

    @media(max-width: 480px), (max-height: 720px){
      :root{
        --barH: clamp(210px, 30vh, 250px);
        --barOffset: 8px;
        --uiScale: 0.96;
        --uiPadX: 14px;
      }
      #bar{ overflow: hidden; }
      .barInner{
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 16px;
      }
      #titleBlock{ gap: 4px; }
      #titleBlock .title{ letter-spacing: .18em; }
      #titleBlock .sub{ letter-spacing: .08em; }
    }
  </style>
</head>

<body>
  <div id="stage">
    <div id="phrase" role="status" aria-live="polite"></div>
  </div>

  <div id="borderFrame" aria-hidden="true">
    <div class="b top"></div>
    <div class="b right"></div>
    <div class="b bottom"></div>
    <div class="b left"></div>
  </div>

  <!-- UI WRAP: title + bar (fades together) -->
  <div id="uiWrap">
    <div id="titleBlock" aria-hidden="true">
      <div class="title">Object Poems</div>
      <div class="sub">written by Margot DeMarco, arranged by ChatGPT</div>
    </div>

    <div id="bar">
      <div class="barInner">

        <!-- SENTENCE STRUCTURE -->
        <div class="row centerRow">
          <div class="grp words">
            <div class="label">Sentence Structure</div>
            <div class="btnGroup centered" id="partsRow"></div>
          </div>
        </div>

        <!-- SLIDERS -->
        <div class="sliderRow">
          <div class="ctrl">
            <div class="labelRow"><div class="label">Speed</div><div class="val" id="speedVal">7.0s</div></div>
            <input id="speedSlider" type="range" min="0" max="1" step="0.001" value="0.595">
          </div>

          <div class="ctrl">
            <div class="labelRow"><div class="label">Background Brightness</div><div class="val" id="bgBrightVal">70%</div></div>
            <input id="bgBrightSlider" type="range" min="0" max="1" step="0.001" value="0.70">
          </div>

          <div class="ctrl">
            <div class="labelRow"><div class="label">Text Brightness</div><div class="val" id="fgBrightVal">17%</div></div>
            <input id="fgBrightSlider" type="range" min="0" max="1" step="0.001" value="0.17">
          </div>

          <div class="ctrl">
            <div class="labelRow"><div class="label">Border Brightness</div><div class="val" id="bdBrightVal">50%</div></div>
            <input id="bdBrightSlider" type="range" min="0" max="1" step="0.001" value="0.50">
          </div>

          <div class="ctrl">
            <div class="labelRow"><div class="label">Border Thickness</div><div class="val" id="bdThickVal">75%</div></div>
            <input id="bdThickSlider" type="range" min="0" max="1" step="0.001" value="0.55">
          </div>

          <div class="actionSlot">
            <button
              id="bdToggleBtn"
              type="button"
              class="colorBtn actionBtn borderBtn"
              aria-pressed="true">
              Border
            </button>
          </div>
        </div>

        <div class="sliderRow">
          <div class="ctrl">
            <div class="labelRow"><div class="label">Size</div><div class="val" id="sizeVal">100%</div></div>
            <input id="sizeSlider" type="range" min="0.6" max="1.6" step="0.001" value="0.8">
          </div>

          <div class="ctrl">
            <div class="labelRow"><div class="label">Height</div><div class="val" id="yVal">50%</div></div>
            <input id="ySlider" type="range" min="0" max="100" step="0.01" value="50">
          </div>

          <div class="ctrl">
            <div class="labelRow"><div class="label">Width</div><div class="val" id="widthVal">50%</div></div>
            <input id="widthSlider" type="range" min="40" max="100" step="0.01" value="50">
          </div>

          <div class="actionSlot">
            <button id="fsBtn" type="button" class="colorBtn actionBtn">Full screen</button>
          </div>
        </div>

        <!-- COLORS -->
        <div class="row colorsRow">
          <div class="grp">
            <div class="swatchWrap">
              <div class="swatchHeader">
                <div class="label">Background Colors</div>
                <div class="val hoverVal" id="bgHover">&nbsp;</div>
              </div>
              <div class="swatchRow" id="bgColorsRow"></div>
            </div>
          </div>

          <div class="grp">
            <div class="swatchWrap">
              <div class="swatchHeader">
                <div class="label">Text Colors</div>
                <div class="val hoverVal" id="fgHover">&nbsp;</div>
              </div>
              <div class="swatchRow" id="fgColorsRow"></div>
            </div>
          </div>

          <div class="grp">
            <div class="swatchWrap">
              <div class="swatchHeader">
                <div class="label">Border Colors</div>
                <div class="val hoverVal" id="bdHover">&nbsp;</div>
              </div>
              <div class="swatchRow" id="bdColorsRow"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ================= Helpers ================= */
function uniq(arr){
  const s = new Set();
  for(const x of arr){
    const v = String(x ?? "").trim().replace(/\s+/g," ");
    if(v) s.add(v);
  }
  return Array.from(s);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function lerp(a,b,t){ return a + (b-a)*t; }

function shuffleInPlace(a){
  for(let i=a.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function setViewportVars(){
  const vv = window.visualViewport;
  const h = (vv ? vv.height : window.innerHeight) * 0.01;
  document.documentElement.style.setProperty("--vh", `${h}px`);
}

function getViewportSize(){
  const vv = window.visualViewport;
  return {
    w: vv ? vv.width : window.innerWidth,
    h: vv ? vv.height : window.innerHeight
  };
}

function parsePx(val){
  const n = Number(String(val || "").replace("px","").trim());
  return Number.isFinite(n) ? n : 0;
}
function getRootVarPx(name){
  return parsePx(getComputedStyle(document.documentElement).getPropertyValue(name));
}

/* ================= Non-repeating shuffle bags ================= */
const BAGS = new Map();
function bagNext(key, pool){
  const cleanPool = uniq(pool);
  if(!cleanPool.length) return null;

  const sig = cleanPool.join("␟");
  const prev = BAGS.get(key);

  if(!prev || prev._sig !== sig){
    const arr = cleanPool.slice();
    shuffleInPlace(arr);
    BAGS.set(key, { arr, i: 0, _sig: sig });
  }
  const bag = BAGS.get(key);
  if(bag.i >= bag.arr.length){
    shuffleInPlace(bag.arr);
    bag.i = 0;
  }
  const out = bag.arr[bag.i];
  bag.i++;
  return out;
}

/* ================= Palettes ================= */
const PAL = {
  circus: ["#FF6AD5","#FF8A00","#FF4D1A","#C85AE0","#FF007A"],
  beachy: ["#BDE8FF","#8FB2CF","#CBE7FF","#445F86","#74A8E8"],
  fleshy: ["#F7D59B","#F6B77D","#B7852F","#F7B59D","#E1780A"],
  future: ["#9EDB00","#C86AD6","#F8C6A4","#B23A2B","#7FB1D9"],
  retro:  ["#DDE6B7","#00AEB0","#D85A10","#B10D33","#F6A623"],
  earthy: ["#A7B827","#D79A16","#536A00","#6F8A1A","#806200"]
};

/* ================= Color helpers ================= */
function hexToRgb(hex){
  const h = hex.replace("#","").trim();
  const full = h.length === 3 ? h.split("").map(c=>c+c).join("") : h;
  const n = parseInt(full,16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}
function rgbToHex(r,g,b){
  const to = (v)=> v.toString(16).padStart(2,"0");
  return "#" + to(r) + to(g) + to(b);
}
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h=0, s=0;
  const l = (max+min)/2;
  const d = max-min;
  if(d !== 0){
    s = d / (1 - Math.abs(2*l - 1));
    switch(max){
      case r: h = ((g-b)/d) % 6; break;
      case g: h = (b-r)/d + 2; break;
      case b: h = (r-g)/d + 4; break;
    }
    h *= 60;
    if(h < 0) h += 360;
  }
  return {h, s, l};
}
function hslToRgb(h,s,l){
  const c = (1 - Math.abs(2*l - 1)) * s;
  const x = c * (1 - Math.abs(((h/60) % 2) - 1));
  const m = l - c/2;
  let rp=0,gp=0,bp=0;

  if(0<=h && h<60){ rp=c; gp=x; bp=0; }
  else if(60<=h && h<120){ rp=x; gp=c; bp=0; }
  else if(120<=h && h<180){ rp=0; gp=c; bp=x; }
  else if(180<=h && h<240){ rp=0; gp=x; bp=c; }
  else if(240<=h && h<300){ rp=x; gp=0; bp=c; }
  else { rp=c; gp=0; bp=x; }

  return { r: Math.round((rp+m)*255), g: Math.round((gp+m)*255), b: Math.round((bp+m)*255) };
}
function setHsl(hex, h, s, l){
  const out = hslToRgb(h, s, l);
  return rgbToHex(out.r,out.g,out.b);
}

/* brightness dimmer */
function applyDimmer(hex, sliderVal){
  const t = clamp(Number(sliderVal), 0, 1);
  const {r,g,b} = hexToRgb(hex);
  let {h,s,l} = rgbToHsl(r,g,b);

  if(Math.abs(t - 0.5) < 1e-6) return hex;

  if(t < 0.5){
    const k = (0.5 - t) / 0.5;
    const lMul = lerp(1.0, 0.42, k);
    l = clamp(l * lMul, 0.08, 0.90);
    s = clamp(s * lerp(1.0, 1.10, k), 0.18, 0.98);
  }else{
    const k = (t - 0.5) / 0.5;
    l = clamp(l + (1 - l) * (0.33 * k), 0.08, 0.92);
    s = clamp(s * lerp(1.0, 1.28, k), 0.18, 0.98);
  }
  return setHsl(hex, h, s, l);
}

function lightestHexFromPalette(palName){
  const pal = PAL[palName] || [];
  let best = pal[0] || "#ffffff";
  let bestL = -1;
  for(const hex of pal){
    const {r,g,b} = hexToRgb(hex);
    const {l} = rgbToHsl(r,g,b);
    if(l > bestL){
      bestL = l;
      best = hex;
    }
  }
  return best;
}
function darkestHexFromPalette(palName){
  const pal = PAL[palName] || [];
  let best = pal[0] || "#000000";
  let bestL = 2;
  for(const hex of pal){
    const {r,g,b} = hexToRgb(hex);
    const {l} = rgbToHsl(r,g,b);
    if(l < bestL){
      bestL = l;
      best = hex;
    }
  }
  return best;
}

/* ================= Controls ================= */
const PART_OPTS = ["description","object","action","location"];
const COLOR_OPTS = ["earthy","beachy","fleshy","retro","future","circus"];
const SLIDER_PALS = ["circus","beachy","fleshy","retro","future","earthy","circus","beachy"];
const palCycleIndex = {};
const swatchRowOffset = { bg: 0, fg: 0, bd: 0 };

function initPaletteCycles(){
  for(const name of COLOR_OPTS) palCycleIndex[name] = 0;
  const palLen = (PAL[COLOR_OPTS[0]] || []).length || 5;
  swatchRowOffset.bg = Math.floor(Math.random() * palLen);
  swatchRowOffset.fg = Math.floor(Math.random() * palLen);
  swatchRowOffset.bd = Math.floor(Math.random() * palLen);
}
function paletteColor(name, offset=0){
  const pal = PAL[name] || [];
  if(!pal.length) return "#000000";
  const idx = palCycleIndex[name] ?? 0;
  return pal[(idx + offset) % pal.length];
}
function advancePaletteCycle(){
  for(const name of COLOR_OPTS){
    const pal = PAL[name] || [];
    if(!pal.length) continue;
    palCycleIndex[name] = (palCycleIndex[name] + 1) % pal.length;
  }
}

/* ================= DOM refs ================= */
const phraseEl = document.getElementById("phrase");
const uiWrapEl = document.getElementById("uiWrap");
const barEl = document.getElementById("bar");
const borderEl = document.getElementById("borderFrame");

const speedEl = document.getElementById("speedSlider");
const bgBrightEl = document.getElementById("bgBrightSlider");
const fgBrightEl = document.getElementById("fgBrightSlider");
const bdBrightEl = document.getElementById("bdBrightSlider");

const sizeEl  = document.getElementById("sizeSlider");
const yEl     = document.getElementById("ySlider");
const widthEl = document.getElementById("widthSlider");

const bdThickEl = document.getElementById("bdThickSlider");
const bdToggleBtn = document.getElementById("bdToggleBtn");
const fsBtn = document.getElementById("fsBtn");

const speedVal = document.getElementById("speedVal");
const bgBrightVal = document.getElementById("bgBrightVal");
const fgBrightVal = document.getElementById("fgBrightVal");
const bdBrightVal = document.getElementById("bdBrightVal");
const sizeVal = document.getElementById("sizeVal");
const yVal = document.getElementById("yVal");
const widthVal = document.getElementById("widthVal");
const bdThickVal = document.getElementById("bdThickVal");

/* hover labels */
const bgHover = document.getElementById("bgHover");
const fgHover = document.getElementById("fgHover");
const bdHover = document.getElementById("bdHover");

const sliderEls = [
  speedEl, bgBrightEl, fgBrightEl, bdBrightEl,
  bdThickEl, sizeEl, yEl, widthEl
];

/* ================= Selection state ================= */
const sel = {
  parts: new Set(PART_OPTS),
  bgColor: new Set(COLOR_OPTS),
  fgColor: new Set(COLOR_OPTS),
  bdColor: new Set(COLOR_OPTS),
  borderEnabled: true,
  borderThickness: Number(bdThickEl.value)
};

/* ================= Vocab banks (CONSOLIDATED: 4 categories only) ================= */
/* Descriptors (DESC_COMMON + DESC_OBSCURE) */
const DESC = uniq([
  "brittle","woolen","velvety","ashen","antique","stately",
  "baggy","bent","brassy","brilliant","bumpy","burnt","buttery","buzzing",
  "charming","crumbly","crunchy","lightly crushed",
  "drafty","dreamy","dusty","dimly lit",
  "feathery","flashy","flavorful","fleshy","foamy","frosted","fruity","fried","furry",
  "gentle","ghostly","gigantic","greasy",
  "hard","jealous","joyful","jazzy","jiggly",
  "leisurely","lively","messy","moldy","mysterious","nervous","oily","orderly","ornamental",
  "painted","pearly","pillowy","poetic","poignant","polished","powdery",
  "ribbed","rocky",
  "salty","sandy","scrambled","sculpted","sculptural","slimy","slippery","smelly","smoggy",
  "soft","stormy","strange","strappy","sweet",
  "thick","thirsty","windy","worried","wrapped",
  "sweaty","sunset","daybreak","elevated","elongated","smooth","curly","twisted","wiggly",
  "burnished","reclusive","exploratory","introverted",
  "dingy","patched","repaired","tarnished","melted","enlarged",
  "moist","dewy","plump","buff","extended","compact","oversized","skimpy",
  "malaise","ennui","weary","blasé","detached","indifferent","futile","languid","listless",
  "vivacious","zestful","vigorous","verve","élan","immersed","flowing","delighted","radiant","witty","buoyant","spontaneous","lighthearted",
  "attentive","subtle","nuanced","deft","precise","perceptive","evocative","suggestive",
  "sparkly","glittery",
  "loud","silent","muffled",
  "wet","damp","dry","cracked",
  "spilt","spoiled","rotten","fresh","growing","withering",
  "elegant","crude","muscular","lean","long","short","tall","slim","chubby",
  "cute","ugly","beautiful","contrasting",
  "hairy","bald","shaved","stubbly","rough","matte","glossy",
  "refined","understated","restrained","poised","tailored","classical",
  "grand","petite","considered","ritualistic","witchy",
  "dried out","lumpy","mindful","civilized","unhurried","guarded",
  "formal","discreet","reserved","confident",
  "diaphanous","opalescent","iridescent","mother-of-pearl","inlaid",
  "sunken","padded","carpeted","sullen","supple","undulating",
  "ubiquitous","obsequious",
  "dulcet","flickering","fugitive","insular","smoky","atonal","hushed","muted",
  "esoteric","arcane","hermetic","cryptic",
  "wistful","pensive","yearning","plaintive","ethereal","reflective",
  "nostalgic","reminiscent","unspoken","unrequited",
  "accepting","tempered","subdued","veiled",
  "balanced","tasteful","delicate","poorly proportioned",
  "gracefully arranged","lightly worn","tenderly handled","gently used",
  "herringbone","stone","quartz","emerald","ruby","diamond encrusted",
  "granite","marble","soapstone","soapy","tie-died","asymmetrical","unbalanced","effervescent","despondent","petulant","hedonistic","gluttonous",
  "malnourished","overflowing","puffy","bloated","maladjusted","transparent","translucent","decaying","plaintive","rueful","unctuous",
  "a sycophantic",
  "anti-fascist","ossified","vermicular","serene","freshly repaired","compact","pocket-sized","distended","muscular","lithe"
]);

/* Objects (ALL merged; no context / no common/obscure split) */
const OBJECTS = uniq([
  "dish rack","drying rack","clothes line","shower head","kitchen sink","vanity mirror","hair brush","toilet paper",
  "coffee mug","tea pot","tea bag","coffee maker","french press","percolator",
  "frying pan","cutting board","crock pot","soupspoon",
  "laundry basket","laundry hamper","trash can","mop bucket","broom",
  "bed","mattress","bookshelf","bookcase","curtains","doorknob","window","lamp","lampshade","clock","wrist watch",
  "cabinet","drawer","coffee table","ottoman","couch","love seat","chaise longue","cushion","throw pillow","duvet","comforter",
  "bath tub","hot tub","jacuzzi",
  "lipstick","lip gloss","blush","makeup","nail polish","perfume bottle","deodorant","hair clip","hair tie",
  "high heels","tights","pantyhose","cardigan","turtleneck","necklace","bracelet","wedding band","ring","pendant",
  "pizza box","mini fridge","refrigerator","oven","freezer","closet","hardwood floor","carpet","rug","upholstery",
  "remote control","computer monitor","ipad","tablet",
  "wardrobe","drapery","portrait","trophy","moving boxes","linen napkin","room service tray","soap",
  "keyboard","printer","xerox machine","photocopier","cash register",
  "envelope","notebook","dictionary","paperback book",
  "workbench","sawhorse","chisel","paint brush","spray paint","ink wash","canvas","plywood","ladder","toolbox","tape measure","scissors",
  "drill press","table saw","bandsaw","vacuum cleaner","hot glue gun","dental pick","drill",
  "office cubicle","lecture hall","waiting room","doctor's office","library","gallery","museum",
  "ATM",
  "seltzer","diner booth","martini","cocktail","wine glass",
  "taqueria","dive bar","dance club","punk club","rave","comedy club","microphone","record store",
  "playing cards","chess board","board game","video game","playstation",
  "slot machine","grand piano","pipe organ","drum kit","synthesizer",
  "bicycle","station wagon","hatchback","convertible","sports car","subaru forester",
  "water slide","trailhead","switchback","mountain lodge","skis",
  "baseball bat",
  "harmonica","folded map","ticket stub",
  "drinking glass","beer stein","high ball glass","ash tray","dust pan","chapstick",
  "dining room table","end table","bedside table","night stand","foot rest","foot stool",
  "step ladder","scaffolding",
  "beer can","beer bottle","canned cocktail","mocktail","mojito","margarita","pilsner","lager","guinness","draft beer",
  "rosé wine","glass of blush","hot toddy","green juice","celery juice","pomegranate juice","carrot juice","tomato juice",
  "noodles","legal pad","note pad","eye drops","bluetooth speaker","SUV","mini-van","lawn mower","air conditioner",
  "recycling bin","white glue","superglue","krazy glue","bouncy ball",
  "bacon egg and cheese","bagel with cream cheese","peanut butter and jelly","hero sandwich","gyro",
  "mission style burrito","enchiladas",
  "t-shirt","tank top","scoop neck shirt","spaghetti strap tank top","undershirt","tube top",
  "push-up bra","bralette","lace thong","lace underwear","lace bra","halter top",
  "knit sweater","knitting needles","ball of yarn",
  "cheeseburger","hamburger","big mac","fried chicken sandwich","grilled chicken sandwich",
  "couscous","quinoa","grain bowl","paint bucket","side salad","caesar salad","greek salad","cucumber salad","seaweed salad","garlicky kale",
  "rice bowl","mexican food","italian food","french food","japanese food","korean food",
  "ham sandwich","ramen","bento box","japanese curry","chicken katsu","karaage","nashville hot fried chicken",
  "pulled pork sandwich","pastrami on rye","egg salad","poached egg","hard boiled egg","soft boiled egg","fried rice",
  "wicker basket","cross-body bag","denim skirt","handbag","shopping cart","purse",
  "catchers mitt","baseball glove","fingerless gloves","driving gloves","steering wheel",
  "gaming chair","rocking chair","vending machine",
  "slate tile","granite counter tops","bulletin board","tie pin","name tag","sheriff's badge",
  "bunk beds","futon","keg of beer","fur pelt","participation trophy",
  "absinthe","fernet","aperol spritz","tequila shot","whisky sour","moo shu pork",
  "propeller beanie","metal detector","geiger counter","nitrous oxide canister","baggie of ketamine","heroin spoon","bag of weed","mushroom chocolate","tab of acid",
  "laser pointer","dvd player","hedge trimmer","weed whacker","dirt bike","chopper","pinwheel",
  "solar panel","sprinter van","ford bronco","riding lawn mower",
  "instruction manual","printed out pdf","roku tv","flip phone","trade paperback","dvd box set","blu-ray player","cd-rom",
  "oled panel","circuit board","circuit breaker","portable fan",
  "croquet mallet","croquette","sizzling fajita platter","bibimbap","wedge salad",
  "director's chair","padded booth","straight jacket","hot dog cart","x-ray machine","samovar of coffee","electric kettle","air fryer",
  "wine decanter","whoopie cushion","sound board","alarm bell","birdbath","birdcage","birdhouse","hourglass","sundial","pendulum","pocket watch",
  "velvet rope","bank vault","water tower","traffic median","airport shuttle",
  "dune buggy","dump truck","freight train","gondola",
  "greenhouse","terrarium",
  "record player","typewriter","ukulele","trombone","tambourine","saxophone","banjo","bagpipe",
  "brownstone","townhouse","alleyway","dumpster","manhole cover","sewer",
  "parking garage","parking lot","driveway",
  "parachute","bungee cord","propeller","umbrella",
  "cooler","cardboard box","tissue box","newspaper","tombstone","baby bottle","maxi pad",
  "deck chair","neon sign","fidget spinner","pack of cigarettes","bow tie","christmas lights","shop vac","crushed cicodin","line of cocaine","hash pipe","opium tea","welding mask","latex mask","leather gloves","hairpiece","chunky heels","reading glasses","tap shoes","kitten heels","sensible pumps","strappy sandals","potted plant","succulent garden","old washing machine"
]);

/* Actions (ACT_COMMON + ACT_OBSCURE) */
const ACTIONS = uniq([
  "blowing in the wind","soaking wet","floating","stretched out","upside-down",
  "broken","misaligned","rusted","folded neatly","left out overnight","cooling slightly","resting quietly","waiting in line",
  "balanced on a ledge","caught in the rain","glowing softly","drying on a rack","spilling a little","sitting untouched",
  "freshly unpacked","carefully stacked","sliding across a table","tucked into a drawer","leaning against a wall",
  "half-finished","freshly cleaned","still warm","still damp","shaking slightly","humming faintly","flickering",
  "dripping quietly","vibrating faintly","flickering softly","humming to itself","half submerged",
  "zipping a suitcase slowly","resting against a window","opening the shutters",
  "standing at the window while the city wakes","steaming",
  "melting on a slice of warm toast","lighting a candle","blowing out a candle","gently dabbing perfume",
  "people watching","caught in a summer rain","under dappled light",
  "pressed into velvet","soaked in sweat","smudged at the edges","warped by heat",
  "straining at the seams","taped up","staining the counter","ringing slightly","treading mud onto the carpet","a little damp","glistening","knocked over","getting a tattoo","shoplifting","crushing garlic","slicing onions",
  "wandering aimlessly","jogging first thing in the morning","pulled a muscle","picking a scab","popping a pimple","vibrating",
  "flossing aggressively","sunbathing","polishing boots","making a smoothie","gesturing wildly","fidgeting anxiously","impatiently waiting",
  "soul-searching","looking within","filled with an overwhelming sense of dread","overcome with malaise","suffering silently","is dented on the corner",
  "slightly angled","heavily distorted","with a skewed perspective","shopping","bored",
  "is smoking a cigarette","sucking on a vape pen",
  "blowing smoke rings","doing kegels","effortlessly arranged","nonchalantly tossed aside","with chipped paint","wrapped in plastic",
  "mounted to the wall","cast in bronze","buried in the back yard","stuck in mud","splayed apart","cast aside","smoldering","glistening",
  "growing taller","getting shorter","shrinking","singing softly","touching itself","throwing a frisbee","playing mini golf","getting a haircut","floating",
  "drying out in the sun","resigned to its fate","crunching the numbers","driving a tractor","buried under rubble","rescued from danger","stuck in a rut",
  "approaching middle age","on its last legs","kicking back","searching for meaning","losing weight","rocking back and forth","self-soothing",
  "comparison shopping","filled with jealousy","stuck in traffic","is getting annoyed","rolling downhill","putting its feet up","tapping lightly",
  "scratching itself","masturbating furiously","committing perjury","serving on a jury","performing surgery","studying German","flipping through a magazine",
  "wearing cutoffs","wearing a bikini","strutting its stuff","freak dancing","doing the macarena","twisting and turning","spinning in circles","pogo dancing",
  "bouncing up and down","buying crypto","lip-syncing","covered in vaseline","lubed up","toweled dry","resting","taking a load off",
  "emitting a high pitched sound","howling","hooting","smiling","frowning","weeping","grinning to itself","standing alone",
  "looking out the window","staring into the middle-distance","losing interest","bored","grumpy","cranky","clingy","getting the ick",
  "sitting on a balcony","left out in the cold","getting moldy","licking its wounds","sick of arguing","with nothing to say","keeping its head down",
  "sobbing softly","caught crying","holding back tears","jacking off",
  "committing fraud","on the run","in hiding","tucked into bed","hiding under the covers","stuck in a tree","carving marble",
  "falling down","toppled over","perfectly posed","out of reach","sipping from a hip flask","doing a keg stand","dehydrated","a little damp",
  "stewing in its own juices","marinating overnight","sitting under a heat lamp","under scrutiny","rollerblading",
  "getting a vitamin drip","squeezing lemons","dancing in the moonlight","dancing in the rain","feeling dried out","meditating",
  "doomscrolling","checking instagram","logging off","with a cracked screen","with a thick accent","tightly wound",
  "carved from a block of wood","getting reupholstered","leaning back","dancing","covered in paint","in a bath robe","in a nightgown",
  "with a bouquet of flowers","under a pile of clothes","cast aside","at the bottom of a well","in despair","overcome with happiness",
  "proud of itself","with incredible skin","blemish-free","dewy-faced","doe eyed","feeling betrayed","got dumped",
  "caught in the rip current","pulled out to see","overeating","binge drinking","hedonistically indulging","sailing due east",
  "riding a dirtbike","landing a kickflip","getting its nails done","getting its hair done","getting its eyebrows tweezed",
  "feeling discouraged","lazily napping","faking an orgasm","practically melting","is ready for a change",
  "is burning bridges","is mending fences","is pissed off","is being gently caressed","all scratched up",
  "is getting wasted","feeling blue","is all tuckered out","is over it","is sitting on its side","is draped in silk",
  "is getting encased in resin","is becoming oxidized","being ignored","getting chilly","working through something"
]);

/* Locations (ALL merged; keep “in/at/on/by…” phrases) */
const LOCATIONS = uniq([
  "in the bedroom","in the kitchen","in the bathroom","in the attic","on the balcony","in the basement","in the backyard","in the driveway",
  "in the apartment","in a spare bedroom","in a long-unused childhood bedroom","in a steamy bathroom","on a balcony chair",
  "in the living room","in the dining room","in a home office","in a craft room","in a pantry","in a soaking tub",
  "in the office","in a cubicle","in a shoemaker's workshop","in the studio","in the lecture hall","in the waiting room",
  "in the doctor's office","in the library","in a tv studio","in a corner office","in an open-plan office",
  "in a ceramics studio","in a construction site","in a movie studio","in a display case","by a printing press",
  "at the beach","on the pier","in the swimming pool","on the sidewalk",
  "Sitting in a diner booth","at a dive bar","at the club","at a rave","at an open mic night",
  "by the fire pit","at the farm stand","at the hardware store",
  "on the trail","on a dirt road","at the trailhead",
  "in the amusement park","in the arcade","in an airport lounge","at a rooftop bar",
  "at a bus stop at dusk","on an empty train platform","at a foggy ferry terminal",
  "stuck to the floor of a movie theater","at an art house theater","at a record store","at a used book store","at a department store","in a food court",
  "in a vacant motel","in a high-rise apartment building","at the top of the bleachers","buried in a shallow grave","in a cemetery",
  "on a basketball court","on a tennis court","on a golf course","at a pumpkin patch","at a pet store","at a strip mall","at an outlet mall",
  "while walking the runway show","in a cafeteria","in a city center","on the outskirts of town","at a beauty pageant",
  "under the overpass","in the parking garage","in the parking lot","at the waterfront","by the water tower","in the alleyway",
  "in a bog","at the catacombs","at the garbage dump",
  "in an off-season seaside town","on an empty boardwalk","among folded deck chairs",
  "outside a closed movie theater","in an empty museum gallery","in an obsolete shopping mall",
  "in back stairwells","beneath a flickering neon sign",
  "on stone steps","on cobblestone","by a courtyard fountain","under overgrown vines","in a vineyard",
  "in a railroad dining car","in the back seat of a car","in the passenger seat of a car","in the driver's seat",
  "in a walk-in freezer","in a breakfast nook","in a dressing room","in a wine bar","in a karaoke bar",
  "in a bank vault","in a root cellar","in a wine cellar","in the trunk of a car","in an overhead bin",
  "in an airplane","in an airport","in a theme park","in a haunted house","in a renovated tenement building",
  "at an amphitheater","at the acropolis","on a suspension bridge","at a dude ranch","at a rodeo","in an automotive plant",
  "in a med spa","in a day spa","in a steam room","at a casino floor","at a poker table","in a clown car","in a dune buggy",
  "in a black box theater","in an improv class","in gym class","in english class",
  "at a book club","in an italian restaurant","in the mall of america","at the world trade center",
  "at the eiffel tower","at the great wall of china","in times square","in soho","in dimes square",
  "in williamsburg","in greenpoint","in bushwick","in a dorm room","at the foot of the bed",
  "at a strip club","at a gay bar","on the upper east side","in chicago","at madison square garden",
  "on the waterfront in portugal","in the south of france","in rolling hills","in tall grasses","on a mowed lawn",
  "in carnegie hall","hanging out","in a loft space","at a pawn shop","at the bottom of a lake",
  "at a beachfront bonfire","on the last day of school","while riding on the back of a horse"
]);

/* ========================================================== */

function pickDescriptor(){ return bagNext("desc", DESC); }
function pickObject(){ return bagNext("obj", OBJECTS); }
function pickAction(){ return bagNext("act", ACTIONS); }
function pickLocation(){ return bagNext("loc", LOCATIONS); }

/* ================= Phrase build ================= */
function safeStr(x){ return (x == null) ? "" : String(x).trim(); }

function buildPhrase(partsSet){
  const useDesc = partsSet.has("description");
  const useObj  = partsSet.has("object");
  const useAct  = partsSet.has("action");
  const useLoc  = partsSet.has("location");
  if(!useDesc && !useObj && !useAct && !useLoc) return "";

  const desc = safeStr(pickDescriptor());
  const obj  = safeStr(pickObject());
  const act  = safeStr(pickAction());
  const loc  = safeStr(pickLocation());

  let out = "";
  if(useDesc && desc) out += desc + " ";
  if(useObj && obj) out += obj;
  if(useAct && act) out += (out ? " " : "") + act;
  if(useLoc && loc) out += (out ? " " : "") + loc;

  out = out.replace(/\s+/g," ").trim();
  return out;
}

/* ================= Color selection ================= */
function unionColorsFrom(selectedPaletteNames){
  const names = Array.from(selectedPaletteNames);
  let out = [];
  for(const n of names){
    const pal = PAL[n];
    if(pal && pal.length) out = out.concat(pal);
  }
  return uniq(out);
}

function pickColorNonRepeating(key, paletteSet, excludeHexSet){
  const pool = unionColorsFrom(paletteSet);
  const allPool = uniq(Object.values(PAL).flat());
  const basePool = pool.length ? pool : allPool;
  const ex = new Set(excludeHexSet ? Array.from(excludeHexSet) : []);
  const filtered = basePool.filter(c => !ex.has(c));
  const usePool = filtered.length ? filtered : basePool;
  return bagNext(key, usePool);
}

function consumeColorFromBag(key, paletteSet, targetHex){
  const pool = unionColorsFrom(paletteSet);
  const allPool = uniq(Object.values(PAL).flat());
  const basePool = pool.length ? pool : allPool;
  for(let i=0; i<basePool.length; i++){
    const c = bagNext(key, basePool);
    if(c === targetHex) return c;
  }
  return targetHex;
}

/* ================= Current frame ================= */
const current = {
  phrase: "",
  bgBase: "#F7C6D0",
  fgBase: "#231423",
  bdBase: "#231423"
};

const last = { phrase:"", bg:"", fg:"", bd:"" };
let timerId = null;
let isFirstFrame = true;

function setCalmStart(){
  const palName = COLOR_OPTS[Math.floor(Math.random() * COLOR_OPTS.length)];
  const bg = lightestHexFromPalette(palName);
  const fg = darkestHexFromPalette(palName);
  current.bgBase = consumeColorFromBag("bg", sel.bgColor, bg);
  current.fgBase = consumeColorFromBag("fg", sel.fgColor, fg);
  current.bdBase = consumeColorFromBag("bd", sel.bdColor, fg);
}

/* ================= UI builders ================= */
function renderSentenceButtons(){
  const container = document.getElementById("partsRow");
  container.innerHTML = "";

  const partToPal = {
    description: "earthy",
    object: "circus",
    action: "beachy",
    location: "retro"
  };

  for(const opt of PART_OPTS){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "ssBtn";
    b.textContent = opt;

    const palName = partToPal[opt];
    const bg = paletteColor(palName, 0);
    b.style.setProperty("--ssPal", palName);
    b.style.setProperty("--ssBg", bg);

    if(sel.parts.has(opt)) b.classList.add("on");

    b.addEventListener("click", ()=>{
      if(sel.parts.has(opt)) sel.parts.delete(opt); else sel.parts.add(opt);
      if(sel.parts.size === 0) sel.parts.add(opt);

      Array.from(container.children).forEach(btn=>{
        const name = btn.textContent;
        btn.classList.toggle("on", sel.parts.has(name));
      });
    });

    container.appendChild(b);
  }
}

function refreshSentenceButtonColors(){
  document.querySelectorAll("#partsRow .ssBtn").forEach(btn=>{
    const pal = btn.style.getPropertyValue("--ssPal").trim() || "earthy";
    btn.style.setProperty("--ssBg", paletteColor(pal, 0));
  });
}

function palettePair(name, offset=0){
  const pal = PAL[name] || [];
  if(!pal.length) return { fill: "#999999", ring: "#cccccc" };
  const fill = paletteColor(name, offset);
  const ring = paletteColor(name, offset + 2);
  return { fill, ring };
}

function renderSwatchRow(rowEl, hoverEl, setRef, rowKey){
  rowEl.innerHTML = "";
  if(rowKey) rowEl.dataset.row = rowKey;

  for(const name of COLOR_OPTS){
    const offset = swatchRowOffset[rowKey] || 0;
    const {fill, ring} = palettePair(name, offset);
    const sw = document.createElement("button");
    sw.type = "button";
    sw.className = "swatch" + (setRef.has(name) ? " on" : "");
    sw.dataset.name = name;
    sw.style.setProperty("--fillCol", fill);
    sw.style.setProperty("--ringCol", ring);

    sw.addEventListener("click", ()=>{
      if(setRef.has(name)) setRef.delete(name); else setRef.add(name);
      if(setRef.size === 0) setRef.add(name);

      Array.from(rowEl.querySelectorAll(".swatch")).forEach(btn=>{
        btn.classList.toggle("on", setRef.has(btn.dataset.name));
      });
    });

    rowEl.appendChild(sw);
  }

  rowEl.addEventListener("mouseover", (e)=>{
    const sw = e.target.closest(".swatch");
    if(!sw) return;
    hoverEl.textContent = (sw.dataset.name || "").toLowerCase();
  });
  rowEl.addEventListener("mouseleave", ()=>{
    hoverEl.innerHTML = "&nbsp;";
  });
}

function refreshSwatchColors(){
  document.querySelectorAll(".swatch").forEach(sw=>{
    const name = sw.dataset.name;
    const row = sw.closest(".swatchRow")?.dataset.row || "bg";
    const offset = swatchRowOffset[row] || 0;
    const {fill, ring} = palettePair(name, offset);
    sw.style.setProperty("--fillCol", fill);
    sw.style.setProperty("--ringCol", ring);
  });
}

function syncSwatchHeaderWidths(){
  requestAnimationFrame(()=>{
    document.querySelectorAll(".swatchRow").forEach(row=>{
      const header = row.parentElement.querySelector(".swatchHeader");
      if(!header) return;
      const w = row.getBoundingClientRect().width;
      header.style.width = w > 0 ? `${w}px` : "auto";
      header.style.marginLeft = "auto";
      header.style.marginRight = "auto";
      row.style.marginLeft = "auto";
      row.style.marginRight = "auto";
    });
  });
}

function applySliderThumbColors(){
  sliderEls.forEach((el, i)=>{
    const palName = SLIDER_PALS[i % SLIDER_PALS.length];
    const pal = PAL[palName] || [];
    const offset = pal.length ? (i % pal.length) : 0;
    const col = paletteColor(palName, offset);
    el.style.setProperty("--thumbCol", col);
  });
}

function applyButtonColors(){
  const fsPal = "retro";
  fsBtn.style.setProperty("--btnBg", paletteColor(fsPal, 1));
  fsBtn.style.setProperty("--btnBd", paletteColor(fsPal, 3));

  const bdPal = "circus";
  bdToggleBtn.style.setProperty("--btnBg", paletteColor(bdPal, 0));
  bdToggleBtn.style.setProperty("--btnBd", paletteColor(bdPal, 2));
}

function syncActionButtonWidths(){
  requestAnimationFrame(()=>{
    const w = fsBtn.getBoundingClientRect().width;
    if(w > 0){
      bdToggleBtn.style.width = `${w}px`;
      fsBtn.style.width = `${w}px`;
    }
  });
}

function applyAccentColors(){
  refreshSwatchColors();
  refreshSentenceButtonColors();
  applySliderThumbColors();
  applyButtonColors();
  syncActionButtonWidths();
}

/* ================= Type + layout ================= */
function applyTypeAndLayout(){
  const scale = clamp(Number(sizeEl.value), 0.6, 1.6);
  document.documentElement.style.setProperty("--textScale", scale);
  sizeVal.textContent = `${Math.round(scale*100)}%`;

  const y = clamp(Number(yEl.value), 0, 100);
  document.documentElement.style.setProperty("--yPct", `${y}%`);
  yVal.textContent = `${Math.round(y)}%`;

  const w = clamp(Number(widthEl.value), 40, 100);
  document.documentElement.style.setProperty("--phraseW", `${w}vw`);
  widthVal.textContent = `${Math.round(w)}%`;

  fitPhraseToBox();
}

function fitPhraseToBox(){
  const text = (phraseEl.textContent || "").trim();
  if(!text){
    document.documentElement.style.setProperty("--fitScale", "1");
    return;
  }

  document.documentElement.style.setProperty("--fitScale", "1");

  requestAnimationFrame(()=>{
    const rect = phraseEl.getBoundingClientRect();
    if(rect.width <= 0 || rect.height <= 0) return;

    const { w: vw, h: vh } = getViewportSize();
    const edgePad = getRootVarPx("--edgePad");
    const widthPct = clamp(Number(widthEl.value), 40, 100) / 100;

    const maxW = Math.min(vw * widthPct, vw - (edgePad * 2));
    const maxH = vh - (edgePad * 2);

    let scale = Math.min(maxW / rect.width, maxH / rect.height, 1);
    if(!Number.isFinite(scale) || scale <= 0) scale = 1;
    scale = clamp(scale, 0.6, 1);

    document.documentElement.style.setProperty("--fitScale", scale.toFixed(3));
  });
}

/* Border grows inward AND outward */
function applyBorderStyle(colorHex){
  const frame = borderEl;
  const t = sel.borderEnabled ? clamp(sel.borderThickness, 0, 1) : 0;

  if(!sel.borderEnabled || t <= 0){
    frame.style.display = "none";
    return;
  }
  frame.style.display = "block";

  const { w, h } = getViewportSize();
  const maxDim = Math.max(w, h);
  const px = Math.max(1, Math.round(t * (maxDim/2)));

  const outside = Math.max(0, Math.round(px * 0.35));

  const topB = frame.querySelector(".top");
  const rightB = frame.querySelector(".right");
  const bottomB = frame.querySelector(".bottom");
  const leftB = frame.querySelector(".left");

  topB.style.background = colorHex;
  rightB.style.background = colorHex;
  bottomB.style.background = colorHex;
  leftB.style.background = colorHex;

  topB.style.top = (-outside) + "px";
  topB.style.height = px + "px";
  topB.style.left = (-outside) + "px";
  topB.style.right = (-outside) + "px";

  bottomB.style.bottom = (-outside) + "px";
  bottomB.style.height = px + "px";
  bottomB.style.left = (-outside) + "px";
  bottomB.style.right = (-outside) + "px";

  leftB.style.left = (-outside) + "px";
  leftB.style.width = px + "px";
  leftB.style.top = (-outside) + "px";
  leftB.style.bottom = (-outside) + "px";

  rightB.style.right = (-outside) + "px";
  rightB.style.width = px + "px";
  rightB.style.top = (-outside) + "px";
  rightB.style.bottom = (-outside) + "px";
}

function pctLabel(x){ return `${Math.round(clamp(Number(x),0,1)*100)}%`; }

/* ================= Speed mapping ================= */
const SPEED_MIN_S = 0.01;
const SPEED_MAX_S = 600;

function speedFromSlider(t){
  t = clamp(Number(t), 0, 1);
  const ratio = SPEED_MAX_S / SPEED_MIN_S;
  return SPEED_MIN_S * Math.pow(ratio, t);
}
function formatDuration(seconds){
  if(seconds < 0.1) return `${Math.round(seconds*1000)}ms`;
  if(seconds < 1) return `${seconds.toFixed(2)}s`;
  if(seconds < 60) return `${seconds.toFixed(seconds < 10 ? 2 : 1)}s`;
  const m = seconds / 60;
  if(m < 10) return `${m.toFixed(2)}m`;
  return `${m.toFixed(1)}m`;
}

/* ================= Visual apply ================= */
function applyColorsLive(){
  const bg = applyDimmer(current.bgBase, Number(bgBrightEl.value));
  let fg  = applyDimmer(current.fgBase, Number(fgBrightEl.value));
  let bd  = applyDimmer(current.bdBase, Number(bdBrightEl.value));

  if(bg.toLowerCase() === fg.toLowerCase()){
    const alt = pickColorNonRepeating("fg:antiEqual", sel.fgColor, new Set([current.bgBase]));
    if(alt) current.fgBase = alt;
    fg = applyDimmer(current.fgBase, Number(fgBrightEl.value));
  }
  if(bd.toLowerCase() === bg.toLowerCase()){
    const altB = pickColorNonRepeating("bd:antiEqual", sel.bdColor, new Set([current.bgBase]));
    if(altB) current.bdBase = altB;
    bd = applyDimmer(current.bdBase, Number(bdBrightEl.value));
  }

  document.body.style.background = bg;
  phraseEl.style.color = fg;

  applyBorderStyle(bd);

  bgBrightVal.textContent = pctLabel(bgBrightEl.value);
  fgBrightVal.textContent = pctLabel(fgBrightEl.value);
  bdBrightVal.textContent = pctLabel(bdBrightEl.value);
  bdThickVal.textContent = `${Math.round(clamp(sel.borderThickness,0,1)*100)}%`;
}

/* ================= Border toggle button sync ================= */
function setBorderBtn(){
  bdToggleBtn.textContent = "Border";
  bdToggleBtn.classList.toggle("on", sel.borderEnabled);
  bdToggleBtn.setAttribute("aria-pressed", sel.borderEnabled ? "true" : "false");
}

/* ================= Fullscreen helpers ================= */
const fsApi = {
  request: document.documentElement.requestFullscreen || document.documentElement.webkitRequestFullscreen || document.documentElement.msRequestFullscreen,
  exit: document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen
};
function isFullscreen(){
  return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
}
function syncFullscreenBtn(){
  if(!fsApi.request || !fsApi.exit){
    fsBtn.style.display = "none";
    return;
  }
  fsBtn.textContent = "Full screen";
  const on = isFullscreen();
  fsBtn.classList.toggle("on", on);
  fsBtn.setAttribute("aria-pressed", on ? "true" : "false");
}

/* ================= Tick loop ================= */
function scheduleTick(){
  if(timerId) clearTimeout(timerId);
  const seconds = speedFromSlider(speedEl.value);
  speedVal.textContent = formatDuration(seconds);
  timerId = setTimeout(()=>{
    nextFrame();
    scheduleTick();
  }, Math.max(10, Math.round(seconds*1000)));
}

/* ================= Frame generation ================= */
function nextFrame(){
  let p = buildPhrase(sel.parts);

  current.phrase = p;
  phraseEl.textContent = current.phrase;
  last.phrase = current.phrase;

  fitPhraseToBox();

  if(isFirstFrame){
    isFirstFrame = false;
  }else{
    const bgBase = pickColorNonRepeating("bg", sel.bgColor, new Set());
    current.bgBase = bgBase || current.bgBase;

    const fgBase = pickColorNonRepeating("fg", sel.fgColor, new Set([current.bgBase]));
    current.fgBase = fgBase || current.fgBase;

    const bdBase = pickColorNonRepeating("bd", sel.bdColor, new Set([current.bgBase, current.fgBase]));
    current.bdBase = bdBase || current.bdBase;
  }

  last.bg = current.bgBase;
  last.fg = current.fgBase;
  last.bd = current.bdBase;

  applyColorsLive();
  advancePaletteCycle();
  applyAccentColors();
}

/* ================= UI hide after inactivity (now hides title too) ================= */
let hideTimer = null;
function showUI(){
  uiWrapEl.classList.remove("hidden");
  if(hideTimer) clearTimeout(hideTimer);
  hideTimer = setTimeout(()=> uiWrapEl.classList.add("hidden"), 3000);
}
["mousemove","mousedown","touchstart","keydown","wheel"].forEach(evt=>{
  window.addEventListener(evt, showUI, {passive:true});
});

/* ================= Events ================= */
speedEl.addEventListener("input", ()=>{ scheduleTick(); showUI(); });
bgBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });
fgBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });
bdBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });

bdThickEl.addEventListener("input", ()=>{
  sel.borderThickness = clamp(Number(bdThickEl.value), 0, 1);
  applyColorsLive();
  showUI();
});

sizeEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });
yEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });
widthEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });

bdToggleBtn.addEventListener("click", ()=>{
  sel.borderEnabled = !sel.borderEnabled;
  setBorderBtn();
  applyColorsLive();
  showUI();
});

fsBtn.addEventListener("click", async ()=>{
  try{
    if(!fsApi.request || !fsApi.exit) return;
    if(!isFullscreen()) await fsApi.request.call(document.documentElement);
    else await fsApi.exit.call(document);
  }catch(e){}
  syncFullscreenBtn();
  showUI();
});

document.addEventListener("fullscreenchange", syncFullscreenBtn);
document.addEventListener("webkitfullscreenchange", syncFullscreenBtn);

/* ================= Start ================= */
(function init(){
  setViewportVars();
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize", setViewportVars, {passive:true});
    window.visualViewport.addEventListener("scroll", setViewportVars, {passive:true});
  }

  initPaletteCycles();
  renderSentenceButtons();

  renderSwatchRow(document.getElementById("bgColorsRow"), bgHover, sel.bgColor, "bg");
  renderSwatchRow(document.getElementById("fgColorsRow"), fgHover, sel.fgColor, "fg");
  renderSwatchRow(document.getElementById("bdColorsRow"), bdHover, sel.bdColor, "bd");
  applyAccentColors();
  syncSwatchHeaderWidths();

  sel.borderEnabled = true;
  sel.borderThickness = clamp(Number(bdThickEl.value), 0, 1);

  setBorderBtn();
  applyTypeAndLayout();

  bgBrightVal.textContent = pctLabel(bgBrightEl.value);
  fgBrightVal.textContent = pctLabel(fgBrightEl.value);
  bdBrightVal.textContent = pctLabel(bdBrightEl.value);
  bdThickVal.textContent = `${Math.round(clamp(sel.borderThickness,0,1)*100)}%`;
  speedVal.textContent = formatDuration(speedFromSlider(speedEl.value));

  syncFullscreenBtn();
  setCalmStart();
  nextFrame();
  scheduleTick();
  showUI();
})();

window.addEventListener("resize", ()=>{
  setViewportVars();
  applyTypeAndLayout();
  applyColorsLive();
  syncSwatchHeaderWidths();
  syncActionButtonWidths();
});
</script>
</body>
</html>
