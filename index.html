
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt Flasher</title>
  <style>
    :root{
      --fg: rgba(35,20,35,0.92);
      --ui: rgba(35,20,35,0.70);
      --ui3: rgba(35,20,35,0.22);

      /* UI sizing */
      --barH: clamp(190px, 23vh, 260px);

      /* Phrase layout */
      --textScale: 1;

      /* DEFAULT phrase position: true vertical center of the WINDOW */
      --yPct: 50%;

      --phraseW: 75vw;
      --edgePad: 50px;

      /* IMPORTANT: positive raises the UI UP (prevents cropping) */
      --barOffset: 50px;

      --btnActive: var(--fg);
    }

    html, body{
      margin:0; padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      background:#F7C6D0;
      font-family: "Times New Roman", Times, Georgia, serif;
      -webkit-text-size-adjust: 100%;
    }

    /* Use dynamic viewport units when available (iOS) */
    body{ min-height: 100vh; }
    @supports (height: 100dvh){
      body{ min-height: 100dvh; }
    }

    /* Stage is ALWAYS full-viewport so 50% is true mid-window */
    #stage{
      position: fixed;
      top:0; left:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
    }
    @supports (height: 100dvh){
      #stage{ height:100dvh; }
    }

    #phrase{
      position:absolute;
      left:50%;
      top: var(--yPct);
      transform: translate(-50%, -50%);
      font-weight: 650;
      font-size: calc(clamp(32px, 5vw, 92px) * var(--textScale));
      line-height:1.12;
      letter-spacing:.2px;
      user-select:none;

      width: var(--phraseW);
      max-width: calc(100vw - (var(--edgePad) * 2));
      text-align:center;

      white-space: normal;
      overflow-wrap: normal;
      word-break: normal;
      hyphens: none;
    }

    /* thick border frame (FULL BLEED, always edge-to-edge) */
#borderFrame{
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;


pointer-events: none;
display: none;


/* Helps iOS avoid weird clipping */
transform: translateZ(0);
}

    /* UI bar */
    #bar{
      position: fixed;
      left:0; right:0;
      bottom: calc(env(safe-area-inset-bottom, 0px) + var(--barOffset));
      height: var(--barH);
      padding: 0 10px calc(10px + env(safe-area-inset-bottom, 0px));
      box-sizing:border-box;
      pointer-events:auto;
      background: transparent;
      transition: opacity .18s ease, transform .18s ease;

      /* Safety: never allow the bar to be taller than the viewport */
      max-height: calc(100vh - 8px);
    }
    @supports (height: 100dvh){
      #bar{ max-height: calc(100dvh - 8px); }
    }

    #bar.hidden{
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
    }

    .barInner{
      padding-top: 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
      box-sizing:border-box;
      overflow: visible;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:nowrap;
      min-width:0;
    }

    .grp{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex: 1 1 auto;
    }

    .grp.word{ flex: 0.62 0.62 0; }
    .grp.context{ flex: 0.88 0.88 0; }
    .grp.parts{ flex: 1.25 1.25 0; }

    .grp.bg{ flex: 1.05 1.05 0; }
    .grp.fg{ flex: 1.05 1.05 0; }
    .grp.bd{ flex: 1.05 1.05 0; }

    .labelRow{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }

    .label{
      font-size: 9px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--ui);
      user-select:none;
      line-height:1;
      opacity:.82;
      display:block;
      white-space:nowrap;
    }
    .val{
      font-size: 9px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--ui);
      opacity:.9;
      user-select:none;
      white-space:nowrap;
    }

    .btnGroup{
      display:flex;
      flex-wrap:wrap;
      gap:4.5px;
      align-items:center;
      min-width:0;
      overflow: visible;
    }

    button{
      font: inherit;
      font-weight: 520;
      font-size: 7.1px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ui);
      background: transparent;
      border: 1px solid var(--ui3);
      border-radius: 999px;
      padding: 3.75px 6px;
      cursor: pointer;
      line-height: 1;
      user-select: none;
      white-space: nowrap;
      transition: transform .05s ease, border-color .15s ease, color .15s ease, border-width .15s ease, font-weight .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button:hover{ color: var(--fg); border-color: var(--ui); }
    button.active{
      border-color: var(--btnActive);
      color: var(--btnActive);
      border-width: 2px;
      font-weight: 900;
    }

    .rightCol{
      display:flex;
      gap:8px;
      align-items:flex-end;
      flex: 0 0 auto;
      padding-left: 6px;
      justify-content:flex-end;
    }

    .sliderRow{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:nowrap;
      min-width:0;
    }

    .ctrl{
      flex: 1 1 0;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }

    input[type=range]{
      appearance:none;
      width:100%;
      height:16px;
      background:transparent;
      color: var(--fg);
      margin:0;
      padding:0;
      touch-action: none;
    }
    input[type=range]::-webkit-slider-runnable-track{
      height:2px;
      background:var(--ui3);
      border-radius:999px;
    }
    input[type=range]::-moz-range-track{
      height:2px;
      background:var(--ui3);
      border-radius:999px;
    }
    input[type=range]::-webkit-slider-thumb{
      appearance:none;
      width:10px; height:10px;
      border-radius:50%;
      background: currentColor;
      margin-top:-4px;
    }
    input[type=range]::-moz-range-thumb{
      width:10px; height:10px;
      border-radius:50%;
      background: currentColor;
      border:0;
    }

    @media(max-width: 980px){
      :root{
        --barH: clamp(250px, 34vh, 340px);
        --barOffset: 35px;
      }
      .row{ flex-wrap:wrap; }
      .sliderRow{ flex-wrap:wrap; }
    }

    @media(max-width: 640px){
      :root{
        --barH: clamp(270px, 40vh, 380px);
        --barOffset: 25px;
      }
      #phrase{ font-size: calc(clamp(28px, 7vw, 70px) * var(--textScale)); }
      button{ font-size: 6.8px; padding: 3.6px 5.3px; }
      .label, .val{ font-size: 8.5px; }
      .btnGroup{ gap:4px; }
    }
  </style>
</head>

<body>
  <div id="stage">
    <div id="phrase"></div>
  </div>
  <div id="borderFrame"></div>

  <div id="bar">
    <div class="barInner">

      <!-- Row 1: buttons -->
      <div class="row">
        <div class="grp word">
          <div class="label">Word</div>
          <div class="btnGroup" id="wordRow"></div>
        </div>

        <div class="grp context">
          <div class="label">Context</div>
          <div class="btnGroup" id="contextRow"></div>
        </div>

        <div class="grp parts">
          <div class="label">Parts</div>
          <div class="btnGroup" id="partsRow"></div>
        </div>
      </div>

      <!-- Row 2: color palette toggles -->
      <div class="row">
        <div class="grp bg">
          <div class="label">Background Color</div>
          <div class="btnGroup" id="bgColorsRow"></div>
        </div>
        <div class="grp fg">
          <div class="label">Text Color</div>
          <div class="btnGroup" id="fgColorsRow"></div>
        </div>
        <div class="grp bd">
          <div class="label">Border Color</div>
          <div class="btnGroup" id="bdColorsRow"></div>
        </div>
      </div>

      <!-- Row 3: sliders -->
      <div class="sliderRow">

        <div class="ctrl">
          <div class="labelRow"><div class="label">Speed</div><div class="val" id="speedVal">5s</div></div>
          <input id="speedSlider" type="range" min="0" max="1" step="0.001" value="0.46">
        </div>

        <div class="ctrl">
          <div class="labelRow"><div class="label">Background Brightness</div><div class="val" id="bgBrightVal">50%</div></div>
          <input id="bgBrightSlider" type="range" min="0" max="1" step="0.001" value="0.5">
        </div>

        <div class="ctrl">
          <div class="labelRow"><div class="label">Text Brightness</div><div class="val" id="fgBrightVal">50%</div></div>
          <input id="fgBrightSlider" type="range" min="0" max="1" step="0.001" value="0.5">
        </div>

        <div class="ctrl">
          <div class="labelRow"><div class="label">Border Brightness</div><div class="val" id="bdBrightVal">50%</div></div>
          <input id="bdBrightSlider" type="range" min="0" max="1" step="0.001" value="0.5">
        </div>

        <div class="ctrl">
          <div class="labelRow"><div class="label">Border Thick</div><div class="val" id="bdThickVal">18%</div></div>
          <input id="bdThickSlider" type="range" min="0" max="1" step="0.001" value="0.18">
        </div>

        <div class="ctrl" style="flex:0.55 0.55 0;">
          <div class="labelRow"><div class="label">Border</div><div class="val">&nbsp;</div></div>
          <button id="bdToggleBtn" type="button" class="active" style="height:16px; padding:0 10px; align-self:flex-start;">On</button>
        </div>

      </div>

      <!-- Row 4: size/width/height + fullscreen -->
      <div class="sliderRow">

        <div class="ctrl">
          <div class="labelRow"><div class="label">Size</div><div class="val" id="sizeVal">100%</div></div>
          <input id="sizeSlider" type="range" min="0.6" max="1.6" step="0.001" value="1.0">
        </div>

        <div class="ctrl">
          <div class="labelRow"><div class="label">Height</div><div class="val" id="yVal">50%</div></div>
          <!-- FULL RANGE: 0 (top) -> 100 (bottom); default 50 (center) -->
          <input id="ySlider" type="range" min="0" max="100" step="0.01" value="50">
        </div>

        <div class="ctrl">
          <div class="labelRow"><div class="label">Width</div><div class="val" id="widthVal">75%</div></div>
          <input id="widthSlider" type="range" min="40" max="100" step="0.01" value="75">
        </div>

        <div class="rightCol">
          <button id="fsBtn" type="button">Full screen</button>
        </div>

      </div>

    </div>
  </div>

<script>
/* ================= Helpers ================= */
function uniq(arr){
  const s = new Set();
  for(const x of arr){
    const v = String(x ?? "").trim().replace(/\s+/g," ");
    if(v) s.add(v);
  }
  return Array.from(s);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function lerp(a,b,t){ return a + (b-a)*t; }

function shuffleInPlace(a){
  for(let i=a.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ================= Non-repeating shuffle bags ================= */
const BAGS = new Map(); // key -> {arr, i, _sig}
function bagNext(key, pool){
  const cleanPool = uniq(pool);
  if(!cleanPool.length) return null;

  const sig = cleanPool.join("␟");
  const prev = BAGS.get(key);

  if(!prev || prev._sig !== sig){
    const arr = cleanPool.slice();
    shuffleInPlace(arr);
    BAGS.set(key, { arr, i: 0, _sig: sig });
  }
  const bag = BAGS.get(key);
  if(bag.i >= bag.arr.length){
    shuffleInPlace(bag.arr);
    bag.i = 0;
  }
  const out = bag.arr[bag.i];
  bag.i++;
  return out;
}

/* ================= Palettes ================= */
const PAL = {
  circus: ["#FF6AD5","#FF8A00","#FF4D1A","#C85AE0","#FF007A"],
  beachy: ["#BDE8FF","#8FB2CF","#CBE7FF","#445F86","#74A8E8"],
  fleshy: ["#F7D59B","#F6B77D","#B7852F","#F7B59D","#E1780A"],
  future: ["#9EDB00","#C86AD6","#F8C6A4","#B23A2B","#7FB1D9"],
  retro:  ["#DDE6B7","#00AEB0","#D85A10","#B10D33","#F6A623"],
  earthy: ["#A7B827","#D79A16","#536A00","#6F8A1A","#806200"]
};

/* ================= Color helpers ================= */
function hexToRgb(hex){
  const h = hex.replace("#","").trim();
  const full = h.length === 3 ? h.split("").map(c=>c+c).join("") : h;
  const n = parseInt(full,16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}
function rgbToHex(r,g,b){
  const to = (v)=> v.toString(16).padStart(2,"0");
  return "#" + to(r) + to(g) + to(b);
}
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h=0, s=0;
  const l = (max+min)/2;
  const d = max-min;
  if(d !== 0){
    s = d / (1 - Math.abs(2*l - 1));
    switch(max){
      case r: h = ((g-b)/d) % 6; break;
      case g: h = (b-r)/d + 2; break;
      case b: h = (r-g)/d + 4; break;
    }
    h *= 60;
    if(h < 0) h += 360;
  }
  return {h, s, l};
}
function hslToRgb(h,s,l){
  const c = (1 - Math.abs(2*l - 1)) * s;
  const x = c * (1 - Math.abs(((h/60) % 2) - 1));
  const m = l - c/2;
  let rp=0,gp=0,bp=0;

  if(0<=h && h<60){ rp=c; gp=x; bp=0; }
  else if(60<=h && h<120){ rp=x; gp=c; bp=0; }
  else if(120<=h && h<180){ rp=0; gp=c; bp=x; }
  else if(180<=h && h<240){ rp=0; gp=x; bp=c; }
  else if(240<=h && h<300){ rp=x; gp=0; bp=c; }
  else { rp=c; gp=0; bp=x; }

  return {
    r: Math.round((rp+m)*255),
    g: Math.round((gp+m)*255),
    b: Math.round((bp+m)*255)
  };
}
function setHsl(hex, h, s, l){
  const out = hslToRgb(h, s, l);
  return rgbToHex(out.r,out.g,out.b);
}

/* brightness “dimmer”:
   - slider 0.5 => exact palette
   - left => darker
   - right => brighter + more saturated
*/
function applyDimmer(hex, sliderVal){
  const t = clamp(Number(sliderVal), 0, 1);
  const {r,g,b} = hexToRgb(hex);
  let {h,s,l} = rgbToHsl(r,g,b);

  if(Math.abs(t - 0.5) < 1e-6) return hex;

  if(t < 0.5){
    const k = (0.5 - t) / 0.5;
    const lMul = lerp(1.0, 0.42, k);
    l = clamp(l * lMul, 0.08, 0.90);
    s = clamp(s * lerp(1.0, 1.10, k), 0.18, 0.98);
  }else{
    const k = (t - 0.5) / 0.5;
    l = clamp(l + (1 - l) * (0.33 * k), 0.08, 0.92);
    s = clamp(s * lerp(1.0, 1.28, k), 0.18, 0.98);
  }
  return setHsl(hex, h, s, l);
}

/* ================= Controls ================= */
const CONTEXT_OPTS = ["home","work","fun"];
const WORD_OPTS = ["common","obscure"];
const PART_OPTS = ["description","object","action","location"];
const COLOR_OPTS = ["circus","beachy","fleshy","earthy","retro","future"];

/* ================= DOM refs ================= */
const phraseEl = document.getElementById("phrase");
const barEl = document.getElementById("bar");
const borderEl = document.getElementById("borderFrame");

const speedEl = document.getElementById("speedSlider");
const bgBrightEl = document.getElementById("bgBrightSlider");
const fgBrightEl = document.getElementById("fgBrightSlider");
const bdBrightEl = document.getElementById("bdBrightSlider");

const sizeEl  = document.getElementById("sizeSlider");
const yEl     = document.getElementById("ySlider");
const widthEl = document.getElementById("widthSlider");

const bdThickEl = document.getElementById("bdThickSlider");
const bdToggleBtn = document.getElementById("bdToggleBtn");
const fsBtn = document.getElementById("fsBtn");

const speedVal = document.getElementById("speedVal");
const bgBrightVal = document.getElementById("bgBrightVal");
const fgBrightVal = document.getElementById("fgBrightVal");
const bdBrightVal = document.getElementById("bdBrightVal");
const sizeVal = document.getElementById("sizeVal");
const yVal = document.getElementById("yVal");
const widthVal = document.getElementById("widthVal");
const bdThickVal = document.getElementById("bdThickVal");

/* ================= UI button builders ================= */
function mkBtn(label, onClick){
  const b = document.createElement("button");
  b.type = "button";
  b.textContent = label;
  b.addEventListener("click", onClick);
  return b;
}
function syncButtons(container, setRef){
  const btns = Array.from(container.querySelectorAll("button"));
  for(const b of btns){
    const k = b.textContent;
    if(setRef.has(k)) b.classList.add("active");
    else b.classList.remove("active");
  }
}
function renderToggleRow(container, options, setRef, onChange){
  container.innerHTML = "";
  for(const opt of options){
    const b = mkBtn(opt, ()=>{
      if(setRef.has(opt)) setRef.delete(opt); else setRef.add(opt);
      if(setRef.size === 0){ setRef.add(opt); }
      syncButtons(container, setRef);
      if(onChange) onChange();
    });
    container.appendChild(b);
  }
  syncButtons(container, setRef);
}

/* ================= Selection state ================= */
const sel = {
  context: new Set(CONTEXT_OPTS),
  word: new Set(WORD_OPTS),
  parts: new Set(PART_OPTS),
  bgColor: new Set(COLOR_OPTS),
  fgColor: new Set(COLOR_OPTS),
  bdColor: new Set(COLOR_OPTS),
  borderEnabled: true,
  borderThickness: Number(bdThickEl.value)
};

/* ================= Vocab banks (FULL, expanded) ================= */
/* Descriptors */
const DESC_COMMON = uniq([
  "brittle","woolen","velvety","ashen","glowing","ambiguous","antique","architectural",
  "baggy","bent","brassy","brilliant","bumpy","burnt","buttery","buzzing",
  "charming","crumbly","crunchy","crushed","crusty",
  "drafty","dreamy","dusty","dim",
  "feathery","flashy","flavorful","fleshy","foggy","foamy","frosted","fruity","fried","furry",
  "gentle","ghostly","gigantic","giggling","greasy",
  "hard","hungry","happy","jealous","joyful","jazzy","jiggly",
  "leisurely","lively","messy","moldy","mysterious","nervous","oily","orderly","ornamental",
  "painted","pearly","pillowy","poetic","poignant","polished","powdery",
  "ribbed","risky","rocky",
  "salty","sandy","scrambled","sculpted","sculptural","slimy","slippery","smelly","smoggy",
  "soft","stormy","strange","strappy","sweet",
  "thick","thirsty","windy","worried","wrapped",
  "sweaty","sunset","daybreak","elevated","elongated","smooth","curly","twisted","wiggly",
  "burnished","reclusive","exploratory","introverted",
  "dingy","patched","repaired","tarnished","dented","angled","tilted","distorted","skewed","melted","enlarged",
  "moist","dewy","plump","buff","extended","compact","oversized","skimpy",
  "malaise","ennui","weary","blasé","detached","indifferent","futile","languid","listless",
  "vivacious","zestful","vigorous","verve","élan","immersed","flowing","delighted","radiant","witty","buoyant","spontaneous","lighthearted",
  "attentive","subtle","nuanced","deft","precise","perceptive","evocative","suggestive",
  "sparkly","glittery",
  "loud","silent","muffled",
  "wet","damp","dry","cracked",
  "spilt","spoiled","rotten","fresh","growing","withering",
  "elegant","crude","muscular","lean","long","short","tall","slim","chubby",
  "cute","ugly","beautiful","contrasting",
  "hairy","bald","shaved","stubbly","rough","matte","glossy",
  "refined","understated","restrained","poised","tailored","classical",
  "grand","petite","considered","ritualistic","witchy",
  "dried out","toweled off","lumpy","mindful","civilized","unhurried","guarded",
  "formal","discreet","reserved","confident",
  "diaphanous","opalescent","iridescent","mother-of-pearl","inlaid",
  "sunken","padded","carpeted",
  "glowering","sullen","beaming","unctuous","supple","undulating",
  "ubiquitous","obsequious",
  "dulcet","flickering","fugitive","insular","smoky","atonal","hushed","muted",
  "esoteric","arcane","hermetic","cryptic",
  "wistful","pensive","yearning","plaintive","ethereal","reflective",
  "nostalgic","reminiscent","unspoken","unrequited",
  "accepting","tempered","subdued","settled","composed","veiled",
  "balanced","effortlessly arranged","nonchalantly placed","tasteful","delicate","proportional",
  "gracefully arranged","lightly worn","tenderly handled","gently used",
  "herringbone-patterned","walnut","mahogany","pine","maple",
  "stone","quartz","emerald","ruby","diamond",
  "granite","marble","soapstone","soapy"
]);
const DESC_OBSCURE = uniq([
  "effervescent","despondent","petulant","hedonistic","gluttonous",
  "malnourished","overflowing","puffy","bloated","misaligned","transparent",
  "decaying","insular","plaintive","rueful","limpid",
  "fugitive","hermetic","cryptic","atonal","unctuous",
  "obsequious","sycophantic","cadent","lacustrine","sepulchral","umbra","penumbral",
  "crepuscular","fuliginous","brumal","noctilucent","nacreous","pellucid",
  "coriaceous","friable","pulverulent","saponaceous","glabrous","hirsute",
  "anfractuous","ossified","vermicular","sere","desiccated","caliginous"
]);

/* Objects */
const OBJ_BASE_HOME = uniq([
  "dish rack","drying rack","clothes line","shower head","kitchen sink","vanity mirror","hair brush","toilet paper",
  "coffee mug","tea pot","tea bag","coffee maker","french press","percolator",
  "frying pan","cutting board","crock pot","soupspoon",
  "laundry basket","laundry hamper","trash can","mop bucket","broom",
  "bed","mattress","bookshelf","bookcase","curtains","doorknob","window","lamp","lampshade","clock","wrist watch",
  "cabinet","drawer","coffee table","ottoman","couch","love seat","chaise longue","cushion","throw pillow","duvet","comforter",
  "bath tub","hot tub","jacuzzi",
  "lipstick","lip gloss","blush","makeup","nail polish","perfume bottle","deodorant","hair clip","hair tie",
  "high heels","tights","pantyhose","cardigan","turtleneck","necklace","bracelet","wedding band","ring","pendant",
  "pizza box","mini fridge","refrigerator","oven","freezer","closet","hardwood floor","carpet","rug","upholstery",
  "remote control","computer monitor","ipad","tablet",
  "wardrobe","drapery","portrait","trophy","moving boxes","linen napkin","room service tray","soap"
]);
const OBJ_BASE_WORK = uniq([
  "computer monitor","keyboard","printer","xerox machine","photocopier","cash register",
  "envelope","notebook","dictionary","paperback book",
  "workbench","sawhorse","chisel","paint brush","spray paint","ink wash","canvas","plywood","ladder","toolbox","tape measure","scissors",
  "drill press","table saw","bandsaw","vacuum cleaner","hot glue gun","dental pick","drill",
  "office cubicle","lecture hall","waiting room","doctor's office","library","gallery","museum",
  "ATM"
]);
const OBJ_BASE_FUN = uniq([
  "seltzer","diner booth","martini","cocktail","wine glass",
  "taqueria","dive bar","dance club","punk club","rave","comedy club","microphone","record store",
  "playing cards","chess board","board game","video game","playstation",
  "slot machine","grand piano","pipe organ","drum kit","synthesizer",
  "bicycle","station wagon","hatchback","convertible","sports car","subaru forester",
  "water slide","trailhead","switchback","mountain lodge","skis",
  "baseball bat",
  "harmonica","folded map","ticket stub"
]);
const USER_COMMON_OBJECTS = uniq([
  "drinking glass","beer stein","high ball glass","ash tray","dust pan","chapstick",
  "dining room table","end table","bedside table","night stand","foot rest","foot stool",
  "step ladder","ladder","scaffolding",
  "beer can","beer bottle","canned cocktail","mocktail","mojito","margarita","pilsner","lager","guinness","draft beer",
  "rosé wine","glass of blush","hot toddy","green juice","celery juice","pomegranate juice","carrot juice","tomato juice",
  "noodles","legal pad","note pad","eye drops","bluetooth speaker","SUV","mini-van","lawn mower","air conditioner",
  "recycling bin","white glue","superglue","krazy glue","bouncy ball",
  "bacon egg and cheese","bagel with cream cheese","peanut butter and jelly","hero sandwich","gyro",
  "mission style burrito","enchiladas",
  "t-shirt","tank top","scoop neck shirt","spaghetti strap tank top","undershirt","tube top",
  "push-up bra","bralette","lace thong","lace underwear","lace bra","halter top",
  "knit sweater","knitting needles","ball of yarn",
  "cheeseburger","hamburger","big mac","fried chicken sandwich","grilled chicken sandwich",
  "couscous","quinoa","grain bowl","paint bucket","side salad","caesar salad","greek salad","cucumber salad","seaweed salad","garlicky kale",
  "rice bowl","mexican food","italian food","french food","japanese food","korean food",
  "ham sandwich","ramen","bento box","japanese curry","chicken katsu","karaage","nashville hot fried chicken",
  "pulled pork sandwich","pastrami on rye","egg salad","poached egg","hard boiled egg","soft boiled egg","fried rice",
  "wicker basket","cross-body bag","denim skirt","handbag","shopping cart","purse",
  "catchers mitt","baseball glove","fingerless gloves","driving gloves","steering wheel",
  "gaming chair","rocking chair","vending machine",
  "slate tile","granite counter tops","bulletin board","tie pin","name tag","sheriff's badge",
  "bunk beds","futon","keg of beer","fur pelt"
]);
const USER_UNCOMMON_OBJECTS = uniq([
  "absinthe","fernet","aperol spritz","tequila sunrise","whisky sour","moo shu pork",
  "propeller beanie","metal detector","geiger counter","whippet","nitrous oxide","ketamine","heroin","DMT","salvia","cannabis","psilocybin","LSD",
  "laser pointer","dvd player","hedge trimmer","weed whacker","dirt bike","chopper","whirlygig","pinwheel",
  "solar panel","sprinter van","ford bronco","riding lawn mower",
  "instruction manual","printed out pdf","roku tv","flip phone","trade paperback","dvd box set","blu-ray player","cd-rom",
  "oled panel","circuit board","circuit breaker","portable fan",
  "croquet mallet","croquette","sizzling fajita platter","bi bim bap","wedge salad",
  "director's chair","padded booth","straight jacket","hot dog cart","x-ray machine","samovar of coffee","electric kettle","air fryer",
  "wine decanter","whoopie cushion"
]);
const OBJ_OBSCURE = uniq([
  "birdbath","birdcage","birdhouse","hourglass","sundial","pendulum","pocket watch",
  "velvet rope","bank vault","water tower","traffic median","airport shuttle",
  "dune buggy","dump truck","freight train","gondola",
  "greenhouse","terrarium",
  "record player","typewriter","ukulele","trombone","tambourine","saxophone","banjo","bagpipe",
  "brownstone","townhouse","alleyway","dumpster","manhole cover","sewer",
  "parking garage","parking lot","driveway",
  "parachute","bungee cord","propeller","umbrella",
  "cooler","cardboard box","tissue paper","newspaper","tombstone","baby bottle","maxi pad",
  "deck chair","neon sign"
].concat(USER_UNCOMMON_OBJECTS));

const OBJ_HOME_COMMON = uniq(OBJ_BASE_HOME.concat(USER_COMMON_OBJECTS));
const OBJ_WORK_COMMON = uniq(OBJ_BASE_WORK.concat([
  "legal pad","note pad","printed out pdf","instruction manual","name tag","sheriff's badge",
  "scaffolding","step ladder","ladder","paint bucket","white glue","superglue","krazy glue","circuit breaker","circuit board","oled panel"
]).concat(USER_COMMON_OBJECTS));
const OBJ_FUN_COMMON  = uniq(OBJ_BASE_FUN.concat([
  "beer stein","beer can","beer bottle","keg of beer","mocktail","mojito","margarita","pilsner","lager","guinness","hot toddy",
  "vending machine","hot dog cart","padded booth","director's chair"
]).concat(USER_COMMON_OBJECTS));

const OBJECTS = {
  home: { common: OBJ_HOME_COMMON, obscure: uniq(OBJ_HOME_COMMON.concat(OBJ_OBSCURE)) },
  work: { common: OBJ_WORK_COMMON, obscure: uniq(OBJ_WORK_COMMON.concat(OBJ_OBSCURE)) },
  fun:  { common: OBJ_FUN_COMMON,  obscure: uniq(OBJ_FUN_COMMON.concat(OBJ_OBSCURE)) }
};

/* Actions */
const ACT_COMMON = uniq([
  "blowing in the wind","soaking wet","floating","stretched out","tilted","inverted",
  "broken","misaligned","rusty","folded neatly","left out overnight","cooling slightly","resting quietly","waiting in line",
  "balanced on a ledge","caught in the rain","glowing softly","drying on a rack","spilling a little","sitting untouched",
  "freshly unpacked","carefully stacked","sliding across a table","tucked into a drawer","leaning against a wall",
  "half-finished","freshly cleaned","still warm","still damp","shaking slightly","humming faintly","flickering"
]);
const ACT_OBSCURE = uniq([
  "dripping quietly","vibrating faintly","flickering softly","humming to itself","half submerged",
  "zipping a suitcase slowly","resting your head against a train window","opening the shutters",
  "standing at the window while the city wakes","coffee cooling before the first sip",
  "butter melting on warm toast","lighting a candle","blowing out a candle","applying perfume",
  "people watching","caught in summer rain","glowing under dappled light",
  "pressed into velvet","caught under neon","sweating through paper","smudged at the edges","warped by heat",
  "straining at the seams","taped up","freshly repaired","staining the counter","ringing slightly"
]);

/* Locations */
const LOC_HOME = uniq([
  "in the bedroom","in the kitchen","in the bathroom","in the attic","on the balcony","in the basement","in the backyard","in the driveway",
  "in the apartment","in a spare bedroom","in a long-unused childhood bedroom","in a steamy bathroom","on a balcony chair",
  "in the living room","in the dining room","in a home office","in a craft room","in a pantry","in a soaking tub"
]);
const LOC_WORK = uniq([
  "in the office","in the cubicle","in the workshop","in the studio","in the lecture hall","in the waiting room",
  "in the doctor's office","in the library","in a tv studio","in a corner office","in an open-plan office",
  "in a ceramics studio","in a construction site","in a movie studio","in a display case","by a printing press"
]);
const LOC_FUN = uniq([
  "at the beach","on the pier","in the swimming pool","on the sidewalk",
  "in a diner booth","at a dive bar","at a dance club","at a punk club","at a rave","at an open mic night",
  "by the fire pit","at the farm stand","at the hardware store",
  "on the trail","on a dirt road","at the trailhead",
  "in the amusement park","in the arcade","in an airport lounge","at a rooftop bar",
  "at a bus stop at dusk","on an empty train platform","at a ferry terminal in fog",
  "at a movie theater","at an art house theater","at a record store","at a used book store","at a department store","in a food court",
  "in a vacant motel","in a high-rise apartment building","at the bleachers","in a graveyard","in a cemetery",
  "on a basketball court","on a tennis court","on a golf course","at a pumpkin patch","at a pet store","at a strip mall","at an outlet mall",
  "at a runway show","in a cafeteria","in a city center","on the outskirts of town"
]);
const LOC_OBSCURE = uniq([
  "under the overpass","in the parking garage","in the parking lot","at the waterfront","by the water tower","in the alleyway",
  "in a bog","at the catacombs","at the garbage dump",
  "in an off-season seaside town","on an empty boardwalk","among folded deck chairs",
  "outside a closed movie theater","in an empty museum gallery","in an obsolete shopping mall",
  "in back stairwells","beneath a flickering neon sign",
  "on stone steps","on cobblestone","by a courtyard fountain","under overgrown vines","in a vineyard",
  "in a railroad dining car","in the back seat of a car","in the passenger seat of a car","in the driver's seat",
  "in a walk-in freezer","in a breakfast nook","in a dressing room","in a wine bar","in a karaoke bar",
  "in a bank vault","in a root cellar","in a wine cellar","in the trunk of a car","in an overhead bin",
  "in an airplane","in an airport","in a theme park","in a haunted house","in a tenement building",
  "at an amphitheater","at the acropolis","on a suspension bridge","at a dude ranch","at a rodeo","in an automotive plant",
  "in a med spa","in a day spa","in a steam room","at a casino floor","at a poker table","in a clown car","in a dune buggy",
  "in a black box theater","in an improv class","in gym class","in english class",
  "at a book club","in an italian restaurant","at mall of america","at the world trade center",
  "at the eiffel tower","at the great wall of china","in times square","in soho","in dimes square",
  "in williamsburg","in greenpoint","in bushwick","in a dorm room","at the foot of the bed",
  "at a strip club","at a gay bar","on the upper east side","in chicago","at madison square garden",
  "in portugal","in france","in rolling hills","in tall grasses","on a mowed lawn"
]);
const USER_COMMON_LOCS = uniq([
  "basketball court","tennis court","golf course","pumpkin patch","pet store","record store","drive-thru","movie theater","art house theater",
  "shoe store","phone booth","hole in the wall restaurant","chiropractor office","pantry","basement","soaking tub","city center","outskirts of town",
  "strip mall","outlet mall","runway show","open mic night","bleachers","graveyard","cemetery","couch","used book store","department store",
  "kitchen","cafeteria","food court","annex","vacant motel","high-rise apartment building","house","home","living room","dining room","home office",
  "man cave","craft room"
]);
const USER_UNCOMMON_LOCS = uniq([
  "construction site","tv studio","corner office","amphitheater","acropolis","suspension bridge","dude ranch","rodeo","automotive plant",
  "open-plan office","med spa","day spa","steam room","railroad dining car","back seat of a car","passenger seat of a car","drivers seat",
  "display case","portugal","france","rolling hills","tall grasses","mowed lawn","casino floor","poker table","clown car","dune buggy",
  "black box theater","improv class","gym class","english class","walk-in freezer","ceramics studio","breakfast nook","dressing room","wine bar",
  "gentleman's club","book club","italian restaurant","mall of america","world trade center","eiffel tower","great wall of china","times square",
  "SOHO","Dimes square","williamsburg","greenpoint","bushwick","dorm room","foot of the bed","strip club","gay bar","upper east side",
  "movie studio","topless bar","campground","chicago","madison square garden","root cellar","wine cellar","bank vault","printing press",
  "karaoke bar","avant garde art show","outsider art museum","modern art museum","contemporary art museum","trunk of a car","overhead bin",
  "airplane","airport","theme park","haunted house","tenement building"
]);

const LOC_HOME_ALL = uniq(LOC_HOME.concat(USER_COMMON_LOCS));
const LOC_WORK_ALL = uniq(LOC_WORK.concat(USER_UNCOMMON_LOCS).concat(USER_COMMON_LOCS));
const LOC_FUN_ALL  = uniq(LOC_FUN.concat(USER_COMMON_LOCS).concat(USER_UNCOMMON_LOCS).concat(LOC_OBSCURE));

function pickFromRarity(poolCommon, poolObscure, rarityKey){
  if(rarityKey === "common") return poolCommon;
  if(rarityKey === "obscure") return poolObscure;
  return uniq(poolCommon.concat(poolObscure));
}

/* ================= Pickers (NO repeats until full cycle) ================= */
function pickDescriptor(rarity){
  const pool = pickFromRarity(DESC_COMMON, uniq(DESC_COMMON.concat(DESC_OBSCURE)), rarity);
  return bagNext(`desc:${rarity}`, pool);
}
function pickObject(context, rarity){
  const bank = (rarity === "common") ? OBJECTS[context].common
             : (rarity === "obscure") ? OBJECTS[context].obscure
             : uniq(OBJECTS[context].common.concat(OBJECTS[context].obscure));
  return bagNext(`obj:${context}|${rarity}`, bank);
}
function pickAction(rarity){
  const pool = pickFromRarity(ACT_COMMON, uniq(ACT_COMMON.concat(ACT_OBSCURE)), rarity);
  return bagNext(`act:${rarity}`, pool);
}
function pickLocation(context, rarity){
  const base = (context === "home") ? LOC_HOME_ALL : (context === "work") ? LOC_WORK_ALL : LOC_FUN_ALL;
  const pool = (rarity === "common") ? base
             : (rarity === "obscure") ? uniq(base.concat(LOC_OBSCURE).concat(USER_UNCOMMON_LOCS))
             : uniq(base.concat(LOC_OBSCURE).concat(USER_UNCOMMON_LOCS));
  return bagNext(`loc:${context}|${rarity}`, pool);
}

/* ================= Color selection (NO repeats; always different) ================= */
function unionColorsFrom(selectedPaletteNames){
  const names = Array.from(selectedPaletteNames);
  let out = [];
  for(const n of names){
    const pal = PAL[n];
    if(pal && pal.length) out = out.concat(pal);
  }
  return uniq(out);
}
function pickColorNonRepeating(key, paletteSet, excludeHexSet){
  let pool = unionColorsFrom(paletteSet);
  const allPool = uniq(Object.values(PAL).flat());
  const ex = excludeHexSet ? new Set(excludeHexSet) : new Set();
  const filtered = pool.filter(c => !ex.has(c));
  pool = filtered.length ? filtered : allPool.filter(c => !ex.has(c));
  return bagNext(key, pool);
}

/* ================= Phrase build (phrase changes ONLY on timer ticks) ================= */
const recentSetP = new Set();
const recentQueue = [];
const RECENT_P = 900;

function rememberPhrase(p){
  recentQueue.push(p);
  recentSetP.add(p);
  if(recentQueue.length > RECENT_P){
    const old = recentQueue.shift();
    recentSetP.delete(old);
  }
}

function buildPhrase(partsSet, rarity, context){
  const useDesc = partsSet.has("description");
  const useObj  = partsSet.has("object");
  const useAct  = partsSet.has("action");
  const useLoc  = partsSet.has("location");
  if(!useDesc && !useObj && !useAct && !useLoc) return "";

  for(let tries=0; tries<600; tries++){
    const desc = pickDescriptor(rarity);
    const obj  = pickObject(context, rarity);
    const act  = pickAction(rarity);
    const loc  = pickLocation(context, rarity);

    let out = "";
    if(useDesc) out += desc + " ";
    if(useObj) out += obj;
    if(useAct) out += (out ? " " : "") + act;
    if(useLoc) out += (out ? " " : "") + loc;

    out = out.replace(/\s+/g," ").trim();
    if(out && !recentSetP.has(out)){
      rememberPhrase(out);
      return out;
    }
  }
  return " ";
}

/* ================= UI render ================= */
renderToggleRow(document.getElementById("contextRow"), CONTEXT_OPTS, sel.context, ()=>{});
renderToggleRow(document.getElementById("wordRow"), WORD_OPTS, sel.word, ()=>{});
renderToggleRow(document.getElementById("partsRow"), PART_OPTS, sel.parts, ()=>{});
renderToggleRow(document.getElementById("bgColorsRow"), COLOR_OPTS, sel.bgColor, ()=>{});
renderToggleRow(document.getElementById("fgColorsRow"), COLOR_OPTS, sel.fgColor, ()=>{});
renderToggleRow(document.getElementById("bdColorsRow"), COLOR_OPTS, sel.bdColor, ()=>{});

function setBorderBtn(){
  bdToggleBtn.textContent = sel.borderEnabled ? "On" : "Off";
  bdToggleBtn.classList.toggle("active", sel.borderEnabled);
}

/* ================= Speed mapping (NO snapping) ================= */
const SPEED_MIN_S = 0.01;
const SPEED_MAX_S = 600;

function speedFromSlider(t){
  t = clamp(Number(t), 0, 1);
  const ratio = SPEED_MAX_S / SPEED_MIN_S;
  return SPEED_MIN_S * Math.pow(ratio, t);
}
function formatDuration(seconds){
  if(seconds < 0.1) return `${Math.round(seconds*1000)}ms`;
  if(seconds < 1) return `${seconds.toFixed(2)}s`;
  if(seconds < 60) return `${seconds.toFixed(seconds < 10 ? 2 : 1)}s`;
  const m = seconds / 60;
  if(m < 10) return `${m.toFixed(2)}m`;
  return `${m.toFixed(1)}m`;
}
function pctLabel(x){ return `${Math.round(clamp(Number(x),0,1)*100)}%`; }

/* ================= Current frame ================= */
const current = {
  phrase: "",
  bgBase: "#F7C6D0",
  fgBase: "#231423",
  bdBase: "#231423",
  context: "home",
  rarity: "common"
};

let timerId = null;

/* ================= Layout + visual apply ================= */
function applyTypeAndLayout(){
  const scale = clamp(Number(sizeEl.value), 0.6, 1.6);
  document.documentElement.style.setProperty("--textScale", scale);
  sizeVal.textContent = `${Math.round(scale*100)}%`;

  // FULL RANGE: 0 -> 100 (true window percentage)
  const y = clamp(Number(yEl.value), 0, 100);
  document.documentElement.style.setProperty("--yPct", `${y}%`);
  yVal.textContent = `${Math.round(y)}%`;

  const w = clamp(Number(widthEl.value), 40, 100);
  document.documentElement.style.setProperty("--phraseW", `${w}vw`);
  widthVal.textContent = `${Math.round(w)}%`;
}

function applyBorderStyle(colorHex){
  if(!sel.borderEnabled || sel.borderThickness <= 0){
    borderEl.style.display = "none";
    return;
  }
  borderEl.style.display = "block";
  const thick = clamp(sel.borderThickness, 0, 1);
  const minDim = Math.min(window.innerWidth, window.innerHeight);
  const px = Math.round(thick * (minDim/2));
  borderEl.style.boxShadow = `inset 0 0 0 ${px}px ${colorHex}`;
}

function applyColorsLive(){
  const bg = applyDimmer(current.bgBase, Number(bgBrightEl.value));
  let fg  = applyDimmer(current.fgBase, Number(fgBrightEl.value));
  let bd  = applyDimmer(current.bdBase, Number(bdBrightEl.value));

  if(bg.toLowerCase() === fg.toLowerCase()){
    const alt = pickColorNonRepeating("fg:antiEqual", sel.fgColor, new Set([current.bgBase]));
    if(alt) current.fgBase = alt;
    fg = applyDimmer(current.fgBase, Number(fgBrightEl.value));
  }
  if(bd.toLowerCase() === bg.toLowerCase()){
    const altB = pickColorNonRepeating("bd:antiEqual", sel.bdColor, new Set([current.bgBase]));
    if(altB) current.bdBase = altB;
    bd = applyDimmer(current.bdBase, Number(bdBrightEl.value));
  }

  document.body.style.background = bg;
  phraseEl.style.color = fg;

  document.documentElement.style.setProperty("--fg", fg);
  document.documentElement.style.setProperty("--btnActive", fg);

  applyBorderStyle(bd);

  bgBrightVal.textContent = pctLabel(bgBrightEl.value);
  fgBrightVal.textContent = pctLabel(fgBrightEl.value);
  bdBrightVal.textContent = pctLabel(bdBrightEl.value);
  bdThickVal.textContent = `${Math.round(clamp(sel.borderThickness,0,1)*100)}%`;
}

function scheduleTick(){
  if(timerId) clearTimeout(timerId);
  const seconds = speedFromSlider(speedEl.value);
  speedVal.textContent = formatDuration(seconds);
  timerId = setTimeout(()=>{
    nextFrame();
    scheduleTick();
  }, Math.max(10, Math.round(seconds*1000)));
}

/* ================= Frame generation ================= */
function nextFrame(){
  const ctx = bagNext("ctx", Array.from(sel.context));
  const rar = bagNext("rar", Array.from(sel.word));
  current.context = ctx || "home";
  current.rarity = rar || "common";

  current.phrase = buildPhrase(sel.parts, current.rarity, current.context);
  phraseEl.textContent = current.phrase;

  const bgBase = pickColorNonRepeating("bg", sel.bgColor, new Set());
  current.bgBase = bgBase || current.bgBase;

  const fgBase = pickColorNonRepeating("fg", sel.fgColor, new Set([current.bgBase]));
  current.fgBase = fgBase || current.fgBase;

  const bdBase = pickColorNonRepeating("bd", sel.bdColor, new Set([current.bgBase, current.fgBase]));
  current.bdBase = bdBase || current.bdBase;

  applyColorsLive();
}

/* ================= UI hide after inactivity ================= */
let hideTimer = null;
function showUI(){
  barEl.classList.remove("hidden");
  if(hideTimer) clearTimeout(hideTimer);
  hideTimer = setTimeout(()=> barEl.classList.add("hidden"), 5000);
}
["mousemove","mousedown","touchstart","keydown","wheel"].forEach(evt=>{
  window.addEventListener(evt, showUI, {passive:true});
});

/* ================= Events ================= */
speedEl.addEventListener("input", ()=>{ scheduleTick(); showUI(); });
bgBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });
fgBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });
bdBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });

bdThickEl.addEventListener("input", ()=>{
  sel.borderThickness = clamp(Number(bdThickEl.value), 0, 1);
  applyColorsLive();
  showUI();
});

sizeEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });
yEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });
widthEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });

bdToggleBtn.addEventListener("click", ()=>{
  sel.borderEnabled = !sel.borderEnabled;
  setBorderBtn();
  applyColorsLive();
  showUI();
});

fsBtn.addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){}
  showUI();
});

/* ================= Start ================= */
(function init(){
  setBorderBtn();
  applyTypeAndLayout();

  bgBrightVal.textContent = pctLabel(bgBrightEl.value);
  fgBrightVal.textContent = pctLabel(fgBrightEl.value);
  bdBrightVal.textContent = pctLabel(bdBrightEl.value);
  bdThickVal.textContent = `${Math.round(clamp(sel.borderThickness,0,1)*100)}%`;
  speedVal.textContent = formatDuration(speedFromSlider(speedEl.value));

  nextFrame();
  scheduleTick();
  showUI();
})();

window.addEventListener("resize", ()=>{
  applyTypeAndLayout();
  applyColorsLive();
});
</script>
</body>
</html>
