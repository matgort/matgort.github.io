<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prompt Flasher</title>
<style>
:root{
--fg: rgba(35,20,35,0.92);
--ui: rgba(35,20,35,0.70);
--ui3: rgba(35,20,35,0.22);


/* UI sizing */
--barH: clamp(190px, 23vh, 260px);
--barOffset: 50px;


/* UI scale +2% */
--uiScale: 1.02;


/* Phrase layout */
--textScale: 1;
--yPct: 50%;
--phraseW: 75vw;
--edgePad: 50px;


--btnActive: var(--fg);
}


html, body{
margin:0; padding:0;
width:100%;
height:100%;
overflow:hidden;
background:#F7C6D0;
font-family: "Times New Roman", Times, Georgia, serif;
-webkit-text-size-adjust: 100%;
}


body{ min-height: 100vh; }
@supports (height: 100dvh){
body{ min-height: 100dvh; }
}


/* Stage above border, below UI */
#stage{
position: fixed;
top:0; left:0;
width:100vw;
height:100vh;
pointer-events:none;
z-index: 20;
}
@supports (height: 100dvh){
#stage{ height:100dvh; }
}


#phrase{
position:absolute;
left:50%;
top: var(--yPct);
transform: translate(-50%, -50%);
font-weight: 650;
font-size: calc(clamp(32px, 5vw, 92px) * var(--textScale));
line-height:1.12;
letter-spacing:.2px;
user-select:none;


width: var(--phraseW);
max-width: calc(100vw - (var(--edgePad) * 2));
text-align:center;


white-space: normal;
overflow-wrap: normal;
word-break: normal;
hyphens: none;
}


/* Border frame always behind text + UI */
#borderFrame{
position: fixed;
inset: 0;
pointer-events: none;
display: none;
z-index: 5;
overflow: visible;
}
]);

function pickDescriptor(){ return bagNext("desc", DESC); }
function pickObject(){ return bagNext("obj", OBJECTS); }
function pickAction(){ return bagNext("act", ACTIONS); }
function pickLocation(){ return bagNext("loc", LOCATIONS); }

/* ================= Color selection ================= */
function unionColorsFrom(selectedPaletteNames){
  const names = Array.from(selectedPaletteNames);
  let out = [];
  for(const n of names){
    const pal = PAL[n];
    if(pal && pal.length) out = out.concat(pal);
  }
  return uniq(out);
}
function pickColorNonRepeating(key, paletteSet, excludeHexSet){
  let pool = unionColorsFrom(paletteSet);
  const allPool = uniq(Object.values(PAL).flat());
  const ex = excludeHexSet ? new Set(excludeHexSet) : new Set();
  const filtered = pool.filter(c => !ex.has(c));
  pool = filtered.length ? filtered : allPool.filter(c => !ex.has(c));
  return bagNext(key, pool);
}

/* ================= Phrase build ================= */
const recentSetP = new Set();
const recentQueue = [];
const RECENT_P = 900;

function rememberPhrase(p){
  recentQueue.push(p);
  recentSetP.add(p);
  if(recentQueue.length > RECENT_P){
    const old = recentQueue.shift();
    recentSetP.delete(old);
  }
}

function buildPhrase(partsSet){
  const useDesc = partsSet.has("description");
  const useObj  = partsSet.has("object");
  const useAct  = partsSet.has("action");
  const useLoc  = partsSet.has("location");
  if(!useDesc && !useObj && !useAct && !useLoc) return "";

  for(let tries=0; tries<600; tries++){
    const desc = pickDescriptor();
    const obj  = pickObject();
    const act  = pickAction();
    const loc  = pickLocation();

    let out = "";
    if(useDesc) out += desc + " ";
    if(useObj) out += obj;
    if(useAct) out += (out ? " " : "") + act;
    if(useLoc) out += (out ? " " : "") + loc;

    out = out.replace(/\s+/g," ").trim();
    if(out && !recentSetP.has(out)){
      rememberPhrase(out);
      return out;
    }
  }
  return " ";
}

/* ================= UI render ================= */
renderToggleRow(document.getElementById("partsRow"), PART_OPTS, sel.parts, ()=>{});
renderToggleRow(document.getElementById("bgColorsRow"), COLOR_OPTS, sel.bgColor, ()=>{});
renderToggleRow(document.getElementById("fgColorsRow"), COLOR_OPTS, sel.fgColor, ()=>{});
renderToggleRow(document.getElementById("bdColorsRow"), COLOR_OPTS, sel.bdColor, ()=>{});

function setBorderBtn(){
  bdToggleBtn.textContent = sel.borderEnabled ? "On" : "Off";
  bdToggleBtn.classList.toggle("active", sel.borderEnabled);
}

/* ================= Speed mapping ================= */
const SPEED_MIN_S = 0.01;
const SPEED_MAX_S = 600;

function speedFromSlider(t){
  t = clamp(Number(t), 0, 1);
  const ratio = SPEED_MAX_S / SPEED_MIN_S;
  return SPEED_MIN_S * Math.pow(ratio, t);
}
function formatDuration(seconds){
  if(seconds < 0.1) return `${Math.round(seconds*1000)}ms`;
  if(seconds < 1) return `${seconds.toFixed(2)}s`;
  if(seconds < 60) return `${seconds.toFixed(seconds < 10 ? 2 : 1)}s`;
  const m = seconds / 60;
  if(m < 10) return `${m.toFixed(2)}m`;
  return `${m.toFixed(1)}m`;
}
function pctLabel(x){ return `${Math.round(clamp(Number(x),0,1)*100)}%`; }

/* ================= Current frame ================= */
const current = {
  phrase: "",
  bgBase: "#F7C6D0",
  fgBase: "#231423",
  bdBase: "#231423"
};

let timerId = null;

/* ================= Layout + visual apply ================= */
function applyTypeAndLayout(){
  const scale = clamp(Number(sizeEl.value), 0.6, 1.6);
  document.documentElement.style.setProperty("--textScale", scale);
  sizeVal.textContent = `${Math.round(scale*100)}%`;

  const y = clamp(Number(yEl.value), 0, 100);
  document.documentElement.style.setProperty("--yPct", `${y}%`);
  yVal.textContent = `${Math.round(y)}%`;

  const w = clamp(Number(widthEl.value), 40, 100);
  document.documentElement.style.setProperty("--phraseW", `${w}vw`);
  widthVal.textContent = `${Math.round(w)}%`;
}

/* Border grows inward AND outward */
function applyBorderStyle(colorHex){
  const frame = borderEl;
  const t = sel.borderEnabled ? clamp(sel.borderThickness, 0, 1) : 0;

  if(!sel.borderEnabled || t <= 0){
    frame.style.display = "none";
    return;
  }
  frame.style.display = "block";

  const minDim = Math.min(window.innerWidth, window.innerHeight);
  const px = Math.max(1, Math.round(t * (minDim/2)));

  const inside = Math.max(0, Math.round(px * 0.55));
  const outside = Math.max(0, px - inside);

  const topB = frame.querySelector(".top");
  const rightB = frame.querySelector(".right");
  const bottomB = frame.querySelector(".bottom");
  const leftB = frame.querySelector(".left");

  topB.style.background = colorHex;
  rightB.style.background = colorHex;
  bottomB.style.background = colorHex;
  leftB.style.background = colorHex;

  topB.style.top = (-outside) + "px";
  topB.style.height = px + "px";
  topB.style.left = (-outside) + "px";
  topB.style.right = (-outside) + "px";

  bottomB.style.bottom = (-outside) + "px";
  bottomB.style.height = px + "px";
  bottomB.style.left = (-outside) + "px";
  bottomB.style.right = (-outside) + "px";

  leftB.style.left = (-outside) + "px";
  leftB.style.width = px + "px";
  leftB.style.top = (-outside) + "px";
  leftB.style.bottom = (-outside) + "px";

  rightB.style.right = (-outside) + "px";
  rightB.style.width = px + "px";
  rightB.style.top = (-outside) + "px";
  rightB.style.bottom = (-outside) + "px";
}

function applyColorsLive(){
  const bg = applyDimmer(current.bgBase, Number(bgBrightEl.value));
  let fg  = applyDimmer(current.fgBase, Number(fgBrightEl.value));
  let bd  = applyDimmer(current.bdBase, Number(bdBrightEl.value));

  if(bg.toLowerCase() === fg.toLowerCase()){
    const alt = pickColorNonRepeating("fg:antiEqual", sel.fgColor, new Set([current.bgBase]));
    if(alt) current.fgBase = alt;
    fg = applyDimmer(current.fgBase, Number(fgBrightEl.value));
  }
  if(bd.toLowerCase() === bg.toLowerCase()){
    const altB = pickColorNonRepeating("bd:antiEqual", sel.bdColor, new Set([current.bgBase]));
    if(altB) current.bdBase = altB;
    bd = applyDimmer(current.bdBase, Number(bdBrightEl.value));
  }

  document.body.style.background = bg;
  phraseEl.style.color = fg;

  document.documentElement.style.setProperty("--fg", fg);
  document.documentElement.style.setProperty("--btnActive", fg);

  applyBorderStyle(bd);

  bgBrightVal.textContent = pctLabel(bgBrightEl.value);
  fgBrightVal.textContent = pctLabel(fgBrightEl.value);
  bdBrightVal.textContent = pctLabel(bdBrightEl.value);
  bdThickVal.textContent = `${Math.round(clamp(sel.borderThickness,0,1)*100)}%`;
}

function scheduleTick(){
  if(timerId) clearTimeout(timerId);
  const seconds = speedFromSlider(speedEl.value);
  speedVal.textContent = formatDuration(seconds);
  timerId = setTimeout(()=>{
    nextFrame();
    scheduleTick();
  }, Math.max(10, Math.round(seconds*1000)));
}

/* ================= Frame generation ================= */
function nextFrame(){
  current.phrase = buildPhrase(sel.parts);
  phraseEl.textContent = current.phrase;

  const bgBase = pickColorNonRepeating("bg", sel.bgColor, new Set());
  current.bgBase = bgBase || current.bgBase;

  const fgBase = pickColorNonRepeating("fg", sel.fgColor, new Set([current.bgBase]));
  current.fgBase = fgBase || current.fgBase;

  const bdBase = pickColorNonRepeating("bd", sel.bdColor, new Set([current.bgBase, current.fgBase]));
  current.bdBase = bdBase || current.bdBase;

  applyColorsLive();
}

/* ================= UI hide after inactivity ================= */
let hideTimer = null;
function showUI(){
  barEl.classList.remove("hidden");
  if(hideTimer) clearTimeout(hideTimer);
  hideTimer = setTimeout(()=> barEl.classList.add("hidden"), 5000);
}
["mousemove","mousedown","touchstart","keydown","wheel"].forEach(evt=>{
  window.addEventListener(evt, showUI, {passive:true});
});

/* ================= Events ================= */
speedEl.addEventListener("input", ()=>{ scheduleTick(); showUI(); });
bgBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });
fgBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });
bdBrightEl.addEventListener("input", ()=>{ applyColorsLive(); showUI(); });

bdThickEl.addEventListener("input", ()=>{
  sel.borderThickness = clamp(Number(bdThickEl.value), 0, 1);
  applyColorsLive();
  showUI();
});

sizeEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });
yEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });
widthEl.addEventListener("input", ()=>{ applyTypeAndLayout(); showUI(); });

bdToggleBtn.addEventListener("click", ()=>{
  sel.borderEnabled = !sel.borderEnabled;
  setBorderBtn();
  applyColorsLive();
  showUI();
});

fsBtn.addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(e){}
  showUI();
});

/* ================= Start ================= */
(function init(){
  setBorderBtn();
  applyTypeAndLayout();

  bgBrightVal.textContent = pctLabel(bgBrightEl.value);
  fgBrightVal.textContent = pctLabel(fgBrightEl.value);
  bdBrightVal.textContent = pctLabel(bdBrightEl.value);
  bdThickVal.textContent = `${Math.round(clamp(sel.borderThickness,0,1)*100)}%`;
  speedVal.textContent = formatDuration(speedFromSlider(speedEl.value));

  nextFrame();
  scheduleTick();
  showUI();
})();

window.addEventListener("resize", ()=>{
  applyTypeAndLayout();
  applyColorsLive();
});
</script>
</body>
</html>
